<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Add Site - Admin</title>
  </head>
  <body>
    <nav>
      <div class="logo">
        <div class="logo-image">
          <img src="" alt="" />
        </div>
      </div>
      <div class="menu-items">
        <ul class="navLinks">
          <li class="navList">
            <a href="dashboard.html">
              <ion-icon name="home-outline"></ion-icon>
              <span class="links">Dashboard</span>
            </a>
          </li>
          <li class="navList">
            <a href="delivery-notes.html">
              <ion-icon name="folder-outline"></ion-icon>
              <span class="links">DN Managment</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-trip.html">
              <ion-icon name="car-sport-outline"></ion-icon>
              <span class="links">Trips Management</span>
            </a>
          </li>
          <li class="navList">
            <a href="accounting.html">
              <ion-icon name="calculator-outline"></ion-icon>
              <span class="links">finance Management</span>
            </a>
          </li>
          <li class="nav-divider"></li>
          <li class="navList active">
            <a href="add-site.html">
              <ion-icon name="location-outline"></ion-icon>
              <span class="links">Add Site</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-truck.html">
              <ion-icon name="car-outline"></ion-icon>
              <span class="links">Add Truck</span>
            </a>
          </li>
          <li class="navList">
            <a href="add_item.html">
              <ion-icon name="cube-outline"></ion-icon>
              <span class="links">Add Item</span>
            </a>
          </li>
        </ul>
        <ul class="bottom-link">
          <li>
            <a href="profile.html">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span class="links">Profile</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="logout()">
              <ion-icon name="log-out-outline"></ion-icon>
              <span class="links">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="data-table">
          <div class="title">
            <ion-icon name="location-outline"></ion-icon>
            <span class="text">Add New Site</span>
          </div>
          <form id="siteForm" class="form-grid">
            <input
              type="text"
              name="site_Code"
              placeholder="Site Code"
              required
            />
            <input
              type="text"
              name="Site_Name"
              placeholder="Site Name"
              required
            />
            <input
              type="text"
              name="Tel_Operator"
              placeholder="Operator/Tenant"
              required
            />
            <textarea name="Address" placeholder="Full Address" rows="2"></textarea>
            <input
              type="number"
              name="Location link"
              placeholder="GPS Latitude"
              step="0.000001"
            />
            <input
              type="number"
              name="Location link data"
              placeholder="GPS Longitude"
              step="0.000001"
            />
            <select name="Site_Type" required>
              <option value="">Select Site Type</option>
              <option value="Macro">Macro</option>
              <option value="Rooftop">Rooftop</option>
              <option value="Indoor">Indoor</option>
              <option value="Small Cell">Small Cell</option>
            </select>
            <textarea
              name="Access_Instructions"
              placeholder="Access Instructions"
            ></textarea>
            <input type="hidden" name="Company_code" value="1000" />
            <button type="submit">Add Site</button>
          </form>
        </div>

        <div class="table-container" id="sitesTable" style="display: block;">
          <div class="table-header">
            <ion-icon name="list-outline"></ion-icon>
            All Sites Database
          </div>
          <div class="search-container" style="padding: 15px; border-bottom: 1px solid #dee2e6;">
            <input type="text" id="siteSearch" placeholder="Search sites by code, name, or operator..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="table-scroll">
            <table class="delivery-notes-table">
              <thead>
                <tr>
                  <th>Site Code</th>
                  <th>Site Name</th>
                  <th>Operator</th>
                  <th>Type</th>
                  <th>Address</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sitesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <script>
      let editingId = null;

      // Check authentication
      if (!sessionStorage.getItem('userRole') || sessionStorage.getItem('userRole') !== 'admin') {
        window.location.href = 'index.html';
      }

      let allSites = [];

      // Auto-load sites on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadSites();
        document.getElementById('siteSearch').addEventListener('input', filterSites);
      });

      document
        .getElementById("siteForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          if (editingId) {
            formData.append("id", editingId);
          }

          try {
            const url = editingId ? "api/update-site.php" : "api/add-site.php";
            const response = await fetch(url, {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              alert(
                editingId
                  ? "Site updated successfully!"
                  : "Site added successfully!"
              );
              this.reset();
              editingId = null;
              loadSites();
            } else {
              alert("Error: " + result.error);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      async function loadSites() {
        try {
          const response = await fetch("api/get-sites.php", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();

          if (result.success) {
            allSites = result.data;
            displaySites(allSites);
            document.getElementById("sitesTable").classList.remove("hidden");
          } else {
            alert("Error loading sites: " + result.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      function displaySites(sites) {
        const tbody = document.getElementById("sitesTableBody");

        if (sites.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <ion-icon name="location-outline" class="empty-icon"></ion-icon>
                            <br>No sites found
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = sites
          .map(
            (site) => `
                <tr>
                    <td><strong>${site.site_Code || "N/A"}</strong></td>
                    <td>${site.Site_Name || "N/A"}</td>
                    <td>${site.Tel_Operator || "N/A"}</td>
                    <td><span class="status-badge status-${(
                      site.Site_Type || "macro"
                    )
                      .toLowerCase()
                      .replace(" ", "-")}">${
              site.Site_Type || "N/A"
            }</span></td>
                    <td title="${site.Address || "N/A"}">${truncateText(
              site.Address || "N/A",
              30
            )}</td>
                    <td>${site.GPS_Latitude && site.GPS_Longitude ? `${site.GPS_Latitude}, ${site.GPS_Longitude}` : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editSite(${
                              site.id
                            })" title="Edit Site">
                                <ion-icon name="create-outline"></ion-icon>
                            </button>
                            <button class="action-btn delete" onclick="deleteSite(${
                              site.id
                            })" title="Delete Site">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function editSite(id) {
        try {
          const response = await fetch("api/get-sites.php", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();

          if (result.success) {
            const site = result.data.find((s) => s.id == id);
            if (site) {
              const siteCodeField = document.querySelector('[name="site_Code"]');
              const siteNameField = document.querySelector('[name="Site_Name"]');
              const operatorField = document.querySelector('[name="Tel_Operator"]');
              const addressField = document.querySelector('[name="Address"]');
              const latField = document.querySelector('[name="Location link"]');
              const lngField = document.querySelector('[name="Location link data"]');
              const typeField = document.querySelector('[name="Site_Type"]');
              const instructionsField = document.querySelector('[name="Access_Instructions"]');
              
              if (siteCodeField) siteCodeField.value = site.site_Code || "";
              if (siteNameField) siteNameField.value = site.Site_Name || "";
              if (operatorField) operatorField.value = site.Tel_Operator || "";
              if (addressField) addressField.value = site.Address || "";
              if (latField) latField.value = site.GPS_Latitude || "";
              if (lngField) lngField.value = site.GPS_Longitude || "";
              if (typeField) typeField.value = site.Site_Type || "";
              if (instructionsField) instructionsField.value = site.Access_Instructions || "";
              
              editingId = id;
            }
          }
        } catch (error) {
          console.error("Error loading site:", error);
        }
      }

      async function deleteSite(id) {
        if (!confirm("Are you sure you want to delete this site?")) return;

        try {
          const formData = new FormData();
          formData.append("id", id);

          const response = await fetch("api/delete-site.php", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            alert("Site deleted successfully!");
            loadSites();
          } else {
            alert("Error: " + result.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      function filterSites() {
        const searchTerm = document.getElementById('siteSearch').value.toLowerCase();
        
        if (!searchTerm) {
          displaySites(allSites);
          return;
        }
        
        const filteredSites = allSites.filter(site => 
          (site.site_Code && site.site_Code.toLowerCase().includes(searchTerm)) ||
          (site.Site_Name && site.Site_Name.toLowerCase().includes(searchTerm)) ||
          (site.Tel_Operator && site.Tel_Operator.toLowerCase().includes(searchTerm)) ||
          (site.Address && site.Address.toLowerCase().includes(searchTerm))
        );
        
        displaySites(filteredSites);
      }

      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }
    </script>

    <script src="js/session.js"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
