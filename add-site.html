<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Add Site - Admin</title>
  </head>
  <body>
    <nav>
      <div class="logo">
        <div class="logo-image">
          <img src="" alt="" />
        </div>
      </div>
      <div class="menu-items">
        <ul class="navLinks">
          <li class="navList">
            <a href="dashboard.html">
              <ion-icon name="home-outline"></ion-icon>
              <span class="links">Dashboard</span>
            </a>
          </li>
          <li class="navList">
            <a href="delivery-notes.html">
              <ion-icon name="folder-outline"></ion-icon>
              <span class="links">Delivery notes</span>
            </a>
          </li>
          <li class="nav-divider"></li>
          <li class="navList active">
            <a href="add-site.html">
              <ion-icon name="location-outline"></ion-icon>
              <span class="links">Add Site</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-truck.html">
              <ion-icon name="car-outline"></ion-icon>
              <span class="links">Add Truck</span>
            </a>
          </li>
          <li class="navList">
            <a href="add_item.html">
              <ion-icon name="cube-outline"></ion-icon>
              <span class="links">Add Item</span>
            </a>
          </li>
        </ul>
        <ul class="bottom-link">
          <li>
            <a href="profile.html">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span class="links">Profile</span>
            </a>
          </li>
          <li>
            <a href="index.html">
              <ion-icon name="log-out-outline"></ion-icon>
              <span class="links">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="data-table">
          <div class="title">
            <ion-icon name="location-outline"></ion-icon>
            <span class="text">Add New Site</span>
          </div>
          <form id="siteForm" class="form-grid">
            <input
              type="text"
              name="site_Code"
              placeholder="Site Code"
              required
            />
            <input
              type="text"
              name="Site_Name"
              placeholder="Site Name"
              required
            />
            <input
              type="text"
              name="Tel_Operator"
              placeholder="Operator/Tenant"
              required
            />
            <input type="text" name="Address" placeholder="Full Address" />
            <input
              type="number"
              name="GPS_Latitude"
              placeholder="GPS Latitude"
              step="0.000001"
            />
            <input
              type="number"
              name="GPS_Longitude"
              placeholder="GPS Longitude"
              step="0.000001"
            />
            <select name="Site_Type" required>
              <option value="">Select Site Type</option>
              <option value="Macro">Macro</option>
              <option value="Rooftop">Rooftop</option>
              <option value="Indoor">Indoor</option>
              <option value="Small Cell">Small Cell</option>
            </select>
            <textarea
              name="Access_Instructions"
              placeholder="Access Instructions"
            ></textarea>
            <input type="text" name="Company_code" placeholder="Company Code" />
            <button type="submit">Add Site</button>
            <button type="button" onclick="loadSites()">Show All Sites</button>
          </form>
        </div>

        <div class="table-container" id="sitesTable">
          <div class="table-header">
            <ion-icon name="list-outline"></ion-icon>
            All Sites Database
          </div>
          <div class="table-scroll">
            <table class="delivery-notes-table">
              <thead>
                <tr>
                  <th>Site Code</th>
                  <th>Site Name</th>
                  <th>Operator</th>
                  <th>Type</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sitesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <script>
      let editingId = null;

      document
        .getElementById("siteForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          if (editingId) {
            formData.append("id", editingId);
          }

          try {
            const url = editingId ? "api/update-site.php" : "api/add-site.php";
            const response = await fetch(url, {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              alert(
                editingId
                  ? "Site updated successfully!"
                  : "Site added successfully!"
              );
              this.reset();
              editingId = null;
              loadSites();
            } else {
              alert("Error: " + result.error);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      async function loadSites() {
        try {
          const response = await fetch("api/get-sites.php");
          const result = await response.json();

          if (result.success) {
            displaySites(result.data);
            document.getElementById("sitesTable").classList.remove("hidden");
          } else {
            alert("Error loading sites: " + result.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      function displaySites(sites) {
        const tbody = document.getElementById("sitesTableBody");

        if (sites.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <ion-icon name="location-outline" class="empty-icon"></ion-icon>
                            <br>No sites found
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = sites
          .map(
            (site) => `
                <tr>
                    <td><strong>${site.site_Code || "N/A"}</strong></td>
                    <td>${site.Site_Name || "N/A"}</td>
                    <td>${site.Tel_Operator || "N/A"}</td>
                    <td><span class="status-badge status-${(
                      site.Site_Type || "macro"
                    )
                      .toLowerCase()
                      .replace(" ", "-")}">${
              site.Site_Type || "N/A"
            }</span></td>
                    <td title="${site.Address || "N/A"}">${truncateText(
              site.Address || "N/A",
              30
            )}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editSite(${
                              site.id
                            })" title="Edit Site">
                                <ion-icon name="create-outline"></ion-icon>
                            </button>
                            <button class="action-btn delete" onclick="deleteSite(${
                              site.id
                            })" title="Delete Site">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function editSite(id) {
        try {
          const response = await fetch("api/get-sites.php");
          const result = await response.json();

          if (result.success) {
            const site = result.data.find((s) => s.id == id);
            if (site) {
              document.querySelector('[name="site_Code"]').value =
                site.site_Code || "";
              document.querySelector('[name="Site_Name"]').value =
                site.Site_Name || "";
              document.querySelector('[name="Tel_Operator"]').value =
                site.Tel_Operator || "";
              document.querySelector('[name="Address"]').value =
                site.Address || "";
              document.querySelector('[name="GPS_Latitude"]').value =
                site.GPS_Latitude || "";
              document.querySelector('[name="GPS_Longitude"]').value =
                site.GPS_Longitude || "";
              document.querySelector('[name="Site_Type"]').value =
                site.Site_Type || "";
              document.querySelector('[name="Access_Instructions"]').value =
                site.Access_Instructions || "";
              document.querySelector('[name="Company_code"]').value =
                site.Company_code || "";
              editingId = id;
            }
          }
        } catch (error) {
          alert("Error loading site: " + error.message);
        }
      }

      async function deleteSite(id) {
        if (!confirm("Are you sure you want to delete this site?")) return;

        try {
          const formData = new FormData();
          formData.append("id", id);

          const response = await fetch("api/delete-site.php", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            alert("Site deleted successfully!");
            loadSites();
          } else {
            alert("Error: " + result.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }
    </script>

    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
