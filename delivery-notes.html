<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Delivery Notes - Admin</title>
  </head>
  <body>
    <nav>
      <div class="logo">
        <div class="logo-image">
          <img src="" alt="" />
        </div>
      </div>
      <div class="menu-items">
        <ul class="navLinks">
          <li class="navList">
            <a href="dashboard.html">
              <ion-icon name="home-outline"></ion-icon>
              <span class="links">Dashboard</span>
            </a>
          </li>
          <li class="navList active">
            <a href="delivery-notes.html">
              <ion-icon name="folder-outline"></ion-icon>
              <span class="links">Delivery notes</span>
            </a>
          </li>
          <li class="nav-divider"></li>
          <li class="navList">
            <a href="add-site.html">
              <ion-icon name="location-outline"></ion-icon>
              <span class="links">Add Site</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-truck.html">
              <ion-icon name="car-outline"></ion-icon>
              <span class="links">Add Truck</span>
            </a>
          </li>
          <li class="navList">
            <a href="add_item.html">
              <ion-icon name="cube-outline"></ion-icon>
              <span class="links">Add Item</span>
            </a>
          </li>
        </ul>
        <ul class="bottom-link">
          <li>
            <a href="profile.html">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span class="links">Profile</span>
            </a>
          </li>
          <li>
            <a href="index.html">
              <ion-icon name="log-out-outline"></ion-icon>
              <span class="links">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="data-table userDetailsTable">
          <div class="title">
            <ion-icon name="folder-outline"></ion-icon>
            <span class="text">Delivery Notes Management</span>
          </div>

          <!-- Upload Section -->
          <div class="upload-section">
            <div class="upload-container">
              <button class="upload-btn" onclick="triggerFileUpload()">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                Upload Excel Sheet
              </button>
              <!-- <button class="upload-btn secondary" onclick="toggleUploadForm()">
                <ion-icon name="add-outline"></ion-icon>
                Add Delivery Note
              </button> -->
              <button class="upload-btn" onclick="showSavedExcelSheets()">
                <ion-icon name="list-outline"></ion-icon>
                Show All Notes
              </button>
              <button
                class="upload-btn danger"
                onclick="clearAllData()"
                id="clearBtn"
                class="hidden"
              >
                <ion-icon name="trash-outline"></ion-icon>
                Clear Data
              </button>

              <div class="search-container">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search delivery notes by DN, customer, project..."
                  onkeypress="handleSearchKeyPress(event)"
                />
                <button class="search-btn" onclick="performSearch()">
                  <ion-icon name="search-outline"></ion-icon>
                  Search
                </button>
                <button
                  class="back-btn"
                  onclick="goBack()"
                  id="backBtn"
                  class="hidden"
                >
                  <ion-icon name="arrow-back-outline"></ion-icon>
                  Back
                </button>
              </div>
            </div>

            <!-- Site Selection for Excel Upload -->
            <div class="upload-form">
              <h3>
                <ion-icon name="location-outline"></ion-icon>
                Select Site to View Delivery Notes
              </h3>
              <select id="excelSiteSelect" required onchange="loadDeliveryNotesBySite()">
                <option value="">Select Site First</option>
              </select>
            </div>

            <!-- Drag and Drop Area -->
            <div
              class="drag-drop-area disabled"
              onclick="triggerFileUpload()"
              id="dragDropArea"
            >
              <input
                type="file"
                id="excelUpload"
                accept=".xlsx,.xls"
                class="hidden"
                disabled
              />
              <div class="icon">
                <ion-icon name="cloud-upload-outline"></ion-icon>
              </div>
              <div class="text">Select a site first, then drag and drop your Excel file here</div>
              <div class="subtext">
                or click to browse for files (.xlsx, .xls)
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Upload Status -->
            <div id="uploadStatus" class="upload-status"></div>

            <!-- Manual Upload Form -->
            <div id="uploadForm" class="upload-form hidden">
              <h3>
                <ion-icon name="add-circle-outline"></ion-icon>
                Add New Delivery Note
              </h3>
              <form id="deliveryNoteForm" onsubmit="submitDeliveryNote(event)">
                <input type="text" id="dnNo" placeholder="DN Number" required />
                <input type="text" id="mrNo" placeholder="MR Number" />
                <input
                  type="text"
                  id="customer"
                  placeholder="Customer"
                  required
                />
                <input
                  type="text"
                  id="projectName"
                  placeholder="Project Name"
                  required
                />
                <select id="siteSelect" required>
                  <option value="">Select Site</option>
                </select>
                <input
                  type="text"
                  id="siteAddress"
                  placeholder="Site Address"
                  readonly
                />
                <input
                  type="text"
                  id="contractInfo"
                  placeholder="Contract Info"
                />
                <input
                  type="text"
                  id="fromWarehouse"
                  placeholder="From Warehouse"
                />
                <input
                  type="text"
                  id="receiverName"
                  placeholder="Receiver Name"
                />
                <input type="tel" id="customerTel" placeholder="Customer Tel" />
                <textarea
                  id="purposeDelivery"
                  placeholder="Purpose of Delivery"
                  rows="3"
                ></textarea>
                <button type="submit">
                  <ion-icon name="save-outline"></ion-icon>
                  Save to Database
                </button>
                <button type="button" onclick="toggleUploadForm()">
                  <ion-icon name="close-outline"></ion-icon>
                  Cancel
                </button>
              </form>
            </div>

            <!-- Processed Excel Data Display -->
            <div id="excelData" class="excel-data hidden">
              <h3>
                <ion-icon name="document-text-outline"></ion-icon>
                Processed Delivery Note Data
              </h3>
              <div id="excelDataContent"></div>
              <div class="button-center">
                <button
                  class="upload-btn"
                  onclick="uploadProcessedData()"
                  id="uploadProcessedBtn"
                >
                  <ion-icon name="cloud-upload-outline"></ion-icon>
                  Upload to Database
                </button>
                <button
                  class="upload-btn secondary hidden"
                  onclick="downloadJSON()"
                  id="downloadJsonBtn"
                  style="display: none;"
                >
                  <ion-icon name="download-outline"></ion-icon>
                  Download JSON
                </button>
              </div>
            </div>
          </div>

          <!-- Error Messages -->
          <div id="errorMessage" class="upload-status error hidden"></div>


        </div>
      </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      // Global variables
      let processedDeliveryNote = null;
      let allDeliveryNotes = [];
      let currentView = "all";
      let currentPage = 1;
      let totalPages = 1;
      let currentSiteCode = '';
      let showingAll = false;

      // DOM elements
      const fileInput = document.getElementById("excelUpload");
      const dragDropArea = document.getElementById("dragDropArea");
      const uploadStatus = document.getElementById("uploadStatus");
      const excelData = document.getElementById("excelData");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const searchInput = document.getElementById("searchInput");
      const backBtn = document.getElementById("backBtn");
      const clearBtn = document.getElementById("clearBtn");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        initializeEventListeners();
        loadSites();
      });

      async function loadDeliveryNotesBySite() {
        const siteCode = document.getElementById('excelSiteSelect').value;
        if (!siteCode) {
          resetTable();
          return;
        }
        
        currentSiteCode = siteCode;
        currentPage = 1;
        showingAll = false;
        
        // Show loading state
        document.getElementById('deliveryNotesTableBody').innerHTML = `
          <tr>
            <td colspan="10" class="empty-state">
              <div class="loading-spinner"></div>
              <br>Loading delivery notes for ${siteCode}...
            </td>
          </tr>
        `;
        
        await fetchDeliveryNotes();
      }

      async function fetchDeliveryNotes() {
        try {
          showError('');
          const limit = showingAll ? 1000 : 10;
          const response = await fetch(`api/get-delivery-notes-by-site.php?site_code=${currentSiteCode}&page=${currentPage}&limit=${limit}`);
          const result = await response.json();
          
          if (result.success) {
            allDeliveryNotes = result.data;
            totalPages = result.totalPages;
            updateDeliveryNotesTable();
            updatePagination(result);
            document.getElementById('tableTitle').textContent = `Delivery Notes for Site: ${currentSiteCode}`;
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          showError('Error loading delivery notes: ' + error.message);
        }
      }

      function resetTable() {
        document.getElementById('deliveryNotesTableBody').innerHTML = `
          <tr>
            <td colspan="17" class="empty-state">
              <ion-icon name="location-outline" class="empty-icon"></ion-icon>
              <br>Select a site to view delivery notes
            </td>
          </tr>
        `;
        document.getElementById('tableTitle').textContent = 'Select a site to view delivery notes';
        document.getElementById('pagination').style.display = 'none';
      }

      function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          fetchDeliveryNotes();
        }
      }

      function showAllNotes() {
        showingAll = true;
        currentPage = 1;
        fetchDeliveryNotes();
      }

      function updatePagination(result) {
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (result.total > 0) {
          pagination.style.display = 'flex';
          pageInfo.textContent = showingAll ? 
            `Showing all ${result.total} notes` : 
            `Page ${result.page} of ${result.totalPages} (${result.total} total)`;
          prevBtn.disabled = result.page <= 1 || showingAll;
          nextBtn.disabled = result.page >= result.totalPages || showingAll;
        } else {
          pagination.style.display = 'none';
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        if (message) {
          errorDiv.textContent = message;
          errorDiv.classList.remove('hidden');
          setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        } else {
          errorDiv.classList.add('hidden');
        }
      }

      async function loadSites() {
        try {
          const response = await fetch('api/get-sites.php');
          const result = await response.json();
          
          if (result.success) {
            // Load sites for form dropdown
            const siteSelect = document.getElementById('siteSelect');
            if (siteSelect) {
              siteSelect.innerHTML = '<option value="">Select Site</option>';
              result.data.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_Code;
                option.textContent = `${site.site_Code} - ${site.Site_Name}`;
                option.dataset.address = site.Address || '';
                siteSelect.appendChild(option);
              });
            }
            
            // Load sites for Excel upload dropdown
            const excelSiteSelect = document.getElementById('excelSiteSelect');
            if (excelSiteSelect) {
              excelSiteSelect.innerHTML = '<option value="">Select Site First</option>';
              result.data.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_Code;
                option.textContent = `${site.site_Code} - ${site.Site_Name}`;
                option.dataset.address = site.Address || '';
                excelSiteSelect.appendChild(option);
              });
            }
          }
        } catch (error) {
          console.error('Error loading sites:', error);
        }
      }

      document.addEventListener('change', function(e) {
        if (e.target.id === 'siteSelect') {
          const selectedOption = e.target.options[e.target.selectedIndex];
          const siteAddress = document.getElementById('siteAddress');
          siteAddress.value = selectedOption.dataset.address || '';
        }
        
        if (e.target.id === 'excelSiteSelect') {
          const dragDropArea = document.getElementById('dragDropArea');
          const fileInput = document.getElementById('excelUpload');
          
          if (e.target.value) {
            // Enable upload when site is selected
            dragDropArea.classList.remove('disabled');
            fileInput.disabled = false;
            dragDropArea.querySelector('.text').textContent = 'Drag and drop your Excel file here';
          } else {
            // Disable upload when no site selected
            dragDropArea.classList.add('disabled');
            fileInput.disabled = true;
            dragDropArea.querySelector('.text').textContent = 'Select a site first, then drag and drop your Excel file here';
          }
        }
      });

      function initializeEventListeners() {
        // File input handling
        fileInput.addEventListener("change", handleFileSelect);

        // Drag and drop
        dragDropArea.addEventListener("dragover", handleDragOver);
        dragDropArea.addEventListener("dragleave", handleDragLeave);
        dragDropArea.addEventListener("drop", handleFileDrop);

        // Prevent default drag behaviors on document
        document.addEventListener("dragover", (e) => e.preventDefault());
        document.addEventListener("drop", (e) => e.preventDefault());
      }

      // File handling functions
      function triggerFileUpload() {
        const excelSiteSelect = document.getElementById('excelSiteSelect');
        if (!excelSiteSelect.value) {
          showStatus('❌ Please select a site first before uploading Excel file', 'error');
          return;
        }
        fileInput.click();
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          processExcelFile(file);
        }
      }

      function handleDragOver(event) {
        event.preventDefault();
        dragDropArea.classList.add("dragover");
      }

      function handleDragLeave(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");
      }

      function handleFileDrop(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          processExcelFile(files[0]);
        }
      }

      // Excel processing functions
      function processExcelFile(file) {
        if (!validateFile(file)) return;

        showStatus("📊 Processing Excel file...", "processing", true);
        updateProgress(10);

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            updateProgress(30);
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {
              type: "array",
              cellStyles: true,
              cellFormulas: true,
              cellDates: true,
            });

            updateProgress(50);

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            updateProgress(70);

            const extractedData = extractDeliveryNoteData(workbook);
            
            // Add selected site code to extracted data
            const selectedSiteCode = document.getElementById('excelSiteSelect').value;
            extractedData.deliveryNote.site_Code = selectedSiteCode;
            
            // Update items with selected site code
            extractedData.items.forEach(item => {
              item.site_code = selectedSiteCode;
            });

            updateProgress(90);

            processedDeliveryNote = extractedData;
            displayExcelData(extractedData.deliveryNote, extractedData.items);

            updateProgress(100);
            showStatus(
              "✅ Excel file processed successfully! Review data and upload to database.",
              "success"
            );
          } catch (error) {
            console.error("Error processing file:", error);
            showStatus(
              "❌ Error processing Excel file: " + error.message,
              "error"
            );
            updateProgress(0);
          }
        };

        reader.onerror = function () {
          showStatus("❌ Error reading file. Please try again.", "error");
          updateProgress(0);
        };

        reader.readAsArrayBuffer(file);
      }

      function validateFile(file) {
        if (!file.name.match(/\.(xlsx|xls)$/i)) {
          showStatus(
            "❌ Please select a valid Excel file (.xlsx or .xls)",
            "error"
          );
          return false;
        }

        if (file.size > 10 * 1024 * 1024) {
          showStatus(
            "❌ File size too large. Please select a file smaller than 10MB",
            "error"
          );
          return false;
        }

        return true;
      }

      function extractDeliveryNoteData(workbook) {
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const getCellValue = (cellRefs) => {
          const refs = Array.isArray(cellRefs) ? cellRefs : [cellRefs];
          for (const cellRef of refs) {
            const cell = worksheet[cellRef];
            if (cell && cell.v !== undefined && cell.v !== "") {
              return String(cell.v).trim();
            }
          }
          return "";
        };

        const deliveryNote = {
          print_date: formatDateTime(getCellValue(["B2", "A2"])) || getCurrentDateTime(),
          purpose_of_delivery: getCellValue(["C3", "D3", "E3"]),
          delivery_address: getCellValue(["C4", "D4", "E4"]),
          site_Code: getCellValue(["C5", "D5", "E5"]),
          contract_info: getCellValue(["C6", "D6", "E6"]),
          Customer: getCellValue(["K8","08"]),
          Customer_PO: getCellValue(["O8", "O8"]),
          Customer_Tel: getCellValue(["M4", "L4"]),
          Project_Name: getCellValue(["C7", "D7", "E7"]),
          Project_Code: getCellValue(["O7", "O7"]),
          Product_Category: getCellValue(["C8", "D8", "E8"]),
          Product_Manager: getCellValue(["K9","09"]),
          Special_Unloading_Req: getCellValue(["C9", "D9", "E9"]),
          Installation_Environment: getCellValue(["C10", "D10", "E10"]),
          Description_MR: getCellValue(["C11", "D11", "E11"]),
          From_Warehouse: getCellValue(["C12", "D12", "E12"]),
          Warehouse_Keeper: getCellValue(["G12", "H12"]),
          Warehouse_Keeper_tel: getCellValue(["O12", "O12"]),
          Description_DN: getCellValue(["C13", "D13", "E13"]),
          Including_dangerous_goods: getCellValue(["C14", "D14", "E14"]) || "No",
          pickup_address: getCellValue(["K3", "03"]),
          Site_Address: getCellValue(["K4","04"]),
          dn_no: getCellValue(["O1", "N1", "P1"]) || generateDNNumber(),
          mr_no: getCellValue(["O2", "N2", "P2"]),
          receiver_name: getCellValue(["O3", "03"]),
          receiver_tel: getCellValue(["O4", "04"]),
          Receiver_Company_Name: getCellValue(["M10", "N10", "O10"]),
          request_arrived_date: formatDateTime(getCellValue(["K5", "05"])),
          request_shipment_date: formatDateTime(getCellValue(["O5", "05"])),
          logistics_specialist: getCellValue(["K6", "06"]),
          logistics_specialist_Tel: getCellValue(["O6", "06"]),
          received_location: getCellValue(["G13", "H13"]),
          received_Auto_location: getCellValue(["G14", "H14"]),
          Collected_location: getCellValue(["G15", "H15"]),
         // Collected_Auto_location: getCellValue(["G16", "H16"]),
          Company_code: '1000'
        };

        // Extract items from second sheet only
        const items = workbook.SheetNames.length > 1 ? 
          extractItemsFromSheet(workbook.Sheets[workbook.SheetNames[1]], deliveryNote.dn_no, deliveryNote.site_Code) : [];
        
        return { deliveryNote, items };
      }

      function extractItemsFromSheet(worksheet, dnNo, siteCode) {
        const items = [];
        
        const getCellValue = (cellRef) => {
          const cell = worksheet[cellRef];
          if (cell && cell.v !== undefined) {
            return cell.w ? String(cell.w).trim() : String(cell.v).trim();
          }
          return "";
        };
        
        // Extract items from rows 2-19 based on the sheet layout
        for (let row = 2; row <= worksheet['!ref'].split(':')[1].replace(/[A-Z]/g, ''); row++) {
          const itemCode = getCellValue(`E${row}`);
          const qty = getCellValue(`F${row}`); 
          const description = getCellValue(`G${row}`);
          
          // Skip header rows
          if (itemCode && (itemCode.toLowerCase().includes('item') || itemCode.toLowerCase().includes('code'))) {
            continue;
          }
          
          if (itemCode || qty || description) {
            items.push({
              dn_no: dnNo,
              site_code: siteCode, 
              item_code: itemCode || '',
              qty: parseFloat(qty) || 0,
              item_description: description || '',
              Company_code: '1000'
            });
          }
        }
        return items;
      }

      function getCellValueByRef(worksheet, cellRef) {
        const cell = worksheet[cellRef];
        if (cell && cell.v !== undefined) {
          // Use formatted value (cell.w) if available, otherwise raw value (cell.v)
          return cell.w ? String(cell.w).trim() : String(cell.v).trim();
        }
        return '';
      }

      // Utility functions
      function formatDateTime(dateValue) {
        if (!dateValue) return null;

        if (typeof dateValue === "string") {
          if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) return dateValue;

          const parsedDate = new Date(dateValue);
          if (!isNaN(parsedDate.getTime())) {
            return parsedDate.toISOString().slice(0, 19).replace("T", " ");
          }
        }

        if (typeof dateValue === "number") {
          try {
            const excelDate = XLSX.SSF.parse_date_code(dateValue);
            if (excelDate) {
              return `${excelDate.y}-${String(excelDate.m).padStart(
                2,
                "0"
              )}-${String(excelDate.d).padStart(2, "0")} 00:00:00`;
            }
          } catch (e) {
            console.warn("Date parsing error:", e);
          }
        }

        return null;
      }

      function getCurrentDateTime() {
        return new Date().toISOString().slice(0, 19).replace("T", " ");
      }

      function generateDNNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const random = Math.floor(Math.random() * 10000)
          .toString()
          .padStart(4, "0");
        return `KSD${year}${month}${day}${random}`;
      }

      // Display functions
      function showStatus(message, type = "success", showSpinner = false) {
        const spinner = showSpinner
          ? '<div class="loading-spinner"></div>'
          : "";
        uploadStatus.innerHTML = `${spinner}${message}`;
        uploadStatus.className = `upload-status ${type}`;
        uploadStatus.style.display = "block";

        if (!showSpinner && type === "success") {
          setTimeout(() => {
            uploadStatus.style.display = "none";
          }, 5000);
        }
      }

      function updateProgress(percentage) {
        progressBar.style.display = "block";
        progressFill.style.width = percentage + "%";

        if (percentage >= 100) {
          setTimeout(() => {
            progressBar.style.display = "none";
          }, 1000);
        }
      }

      function displayExcelData(deliveryNote, items) {
        let html = `
          <div class="extraction-sections">
            <div class="delivery-note-section">
              <h4><ion-icon name="document-text-outline"></ion-icon> Delivery Note (Sheet 1)</h4>
              <div class="data-grid">
        `;

        const fieldLabels = {
          print_date: "Print Date", dn_no: "DN Number", mr_no: "MR Number",
          Customer: "Customer", Project_Name: "Project Name", site_Code: "Site Code",
          From_Warehouse: "From Warehouse", Product_Manager: "Product Manager"
        };

        for (const [key, value] of Object.entries(deliveryNote)) {
          if (value && value.toString().trim() !== "") {
            const label = fieldLabels[key] || key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
            html += `
              <div class="data-item">
                <strong>${label}</strong>
                <span>${value}</span>
              </div>
            `;
          }
        }

        html += '</div></div>';
        
        // Add items section
        html += `
          <div class="items-section">
            <h4><ion-icon name="cube-outline"></ion-icon> Items (Sheet 2) - ${items.length} items</h4>
        `;
        
        if (items && items.length > 0) {
          html += '<div class="items-table-container"><table class="items-table"><thead><tr><th>Item Description</th><th>QTY</th><th>Item Code</th><th>Status</th></tr></thead><tbody>';
          items.forEach((item, index) => {
            html += `
              <tr>
                <td class="description-cell" title="${item.item_description || 'N/A'}">${item.item_description || 'N/A'}</td>
                <td>${item.qty}</td>
                <td><strong>${item.item_code}</strong></td>
                <td><span class="status-badge status-created">Created</span></td>
              </tr>
            `;
          });
          html += '</tbody></table></div>';
        } else {
          html += '<div class="no-items">No items found in second sheet</div>';
        }
        
        html += '</div></div>';
        
        document.getElementById("excelDataContent").innerHTML = html;
        excelData.style.display = "block";
        clearBtn.style.display = "inline-flex";
      }

      // Form handling
      function toggleUploadForm() {
        const form = document.getElementById("uploadForm");
        form.style.display = form.style.display === "none" ? "block" : "none";

        if (form.style.display === "block") {
          document.getElementById("dnNo").focus();
        }
      }

      function submitDeliveryNote(event) {
        event.preventDefault();

        const formData = {
          dn_no: document.getElementById("dnNo").value,
          Customer: document.getElementById("customer").value,
          Project_Name: document.getElementById("projectName").value,
          Site_Address: document.getElementById("siteAddress").value,
          site_Code: document.getElementById("siteSelect").value,
          Customer_PO: document.getElementById("customerPO").value || "",
          Customer_Tel: document.getElementById("customerTel").value || "",
          Project_Code: document.getElementById("projectCode").value ,
          Product_Category:
            document.getElementById("productCategory").value || "",
          Product_Manager:
            document.getElementById("productManager").value,
          receiver_name: document.getElementById("receiverName").value,
          receiver_tel: document.getElementById("receiverTel").value,
          Receiver_Company_Name:
            document.getElementById("receiverCompany").value || "",
        };

        uploadToDatabase(formData);
      }

      // Database operations
      async function uploadProcessedData() {
        if (!processedDeliveryNote) {
          showStatus("❌ No data to upload", "error");
          return;
        }

        await uploadToDatabase(processedDeliveryNote.deliveryNote, processedDeliveryNote.items);
      }

      async function uploadToDatabase(deliveryNote, items = []) {
        try {
          showStatus("🚀 Uploading to database...", "processing", true);
          updateProgress(20);

          const response = await fetch("api/upload-delivery-note.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ deliveryNote, items }),
          });

          updateProgress(60);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          updateProgress(90);

          if (result.success) {
            updateProgress(100);
            showStatus(
              `✅ Successfully uploaded! DN: ${result.dn_no || deliveryNote.dn_no} with ${items.length} items`,
              "success"
            );

            // Refresh delivery notes for current site
            if (currentSiteCode === deliveryNote.site_Code) {
              await fetchDeliveryNotes();
            }

            // Reset forms
            clearExcelData();
            if (document.getElementById("deliveryNoteForm")) {
              document.getElementById("deliveryNoteForm").reset();
            }
          } else {
            throw new Error(result.error || "Upload failed");
          }
        } catch (error) {
          console.error("Upload error:", error);
          updateProgress(0);

          let errorMessage = "❌ Upload failed: ";
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            errorMessage +=
              "Cannot connect to server. Please check if api/api/upload-delivery-note.php exists.";
          } else {
            errorMessage += error.message;
          }

          showStatus(errorMessage, "error");
        }
      }

      async function loadDeliveryNotes() {
        try {
          const response = await fetch("api/get-delivery-notes.php");
          const result = await response.json();

          if (result.success) {
            allDeliveryNotes = result.data;
            updateDeliveryNotesTable();
          } else {
            console.error("Error loading delivery notes:", result.error);
            updateDeliveryNotesTable();
          }
        } catch (error) {
          console.error("Error:", error);
          updateDeliveryNotesTable();
        }
      }

      function updateDeliveryNotesTable(notesToShow = null) {
        const tbody = document.getElementById("deliveryNotesTableBody");
        const notes = notesToShow || allDeliveryNotes;

        if (notes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="10" class="empty-state">
                <ion-icon name="document-outline" class="empty-icon"></ion-icon>
                <br>No delivery notes found
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = notes
          .map(
            (note) => `
          <tr>
            <td class="col-dn"><strong>${note.dn_no || "N/A"}</strong></td>
            <td class="col-mr">${note.mr_no || "N/A"}</td>
            <td class="col-site">${note.site_Code || "N/A"}</td>
            <td class="col-customer" title="${note.Customer || "N/A"}">${truncateText(note.Customer || "N/A", 20)}</td>
            <td class="col-project" title="${note.Project_Name || "N/A"}">${truncateText(note.Project_Name || "N/A", 25)}</td>
            <td class="col-manager" title="${note.Product_Manager || "N/A"}">${truncateText(note.Product_Manager || "N/A", 15)}</td>
            <td class="col-warehouse" title="${note.From_Warehouse || "N/A"}">${truncateText(note.From_Warehouse || "N/A", 15)}</td>
            <td class="col-date">${formatDisplayDate(note.request_arrived_date) || "N/A"}</td>
            <td class="col-status"><span class="status-badge status-${(
              note.DN_Status || "created"
            ).toLowerCase()}">${note.DN_Status || "Created"}</span></td>
            <td class="col-actions">
              <div class="action-buttons">
                <button class="action-btn view" onclick="viewDeliveryNote(${
                  note.id
                })" title="View Details">
                  <ion-icon name="eye-outline"></ion-icon>
                </button>
                <button class="action-btn edit" onclick="editDeliveryNote(${
                  note.id
                })" title="Edit">
                  <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="action-btn delete" onclick="deleteDeliveryNote(${
                  note.id
                })" title="Delete">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Utility functions for table
      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }

      function formatDisplayDate(dateString) {
        if (!dateString) return "N/A";
        try {
          const date = new Date(dateString);
          return (
            date.toLocaleDateString() +
            " " +
            date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
          );
        } catch {
          return dateString;
        }
      }

      // Search and filter functions
      function handleSearchKeyPress(event) {
        if (event.key === "Enter") {
          performSearch();
        }
      }

      function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          showStatus("Please enter a search term", "error");
          return;
        }

        const filteredNotes = allDeliveryNotes.filter(
          (note) =>
            (note.dn_no && note.dn_no.toLowerCase().includes(searchTerm)) ||
            (note.customer &&
              note.customer.toLowerCase().includes(searchTerm)) ||
            (note.project_name &&
              note.project_name.toLowerCase().includes(searchTerm)) ||
            (note.site_address &&
              note.site_address.toLowerCase().includes(searchTerm)) ||
            (note.mr_no && note.mr_no.toLowerCase().includes(searchTerm))
        );

        updateDeliveryNotesTable(filteredNotes);
        backBtn.style.display = "inline-flex";
        currentView = "search";

        showStatus(
          `Found ${filteredNotes.length} delivery note(s) matching "${searchTerm}"`,
          "success"
        );
      }

      function goBack() {
        searchInput.value = "";
        backBtn.style.display = "none";
        currentView = "all";
        updateDeliveryNotesTable();
        showStatus("Showing all delivery notes", "success");
      }

      // Additional functions
      async function showSavedExcelSheets() {
        if (!currentSiteCode) {
          showError('Please select a site first to view delivery notes');
          return;
        }
        
        showingAll = true;
        currentPage = 1;
        await fetchDeliveryNotes();
      }

      function clearExcelData() {
        processedDeliveryNote = null;
        excelData.style.display = "none";
        clearBtn.style.display = "none";
        fileInput.value = "";
        showStatus("Excel data cleared", "success");
      }

      function clearAllData() {
        if (
          confirm(
            "Are you sure you want to clear all processed data? This will not affect the database."
          )
        ) {
          clearExcelData();
          document.getElementById("deliveryNoteForm").reset();
          toggleUploadForm();
        }
      }

      function downloadJSON() {
        if (!processedDeliveryNote) {
          showStatus("No data to download", "error");
          return;
        }

        const dataStr = JSON.stringify(processedDeliveryNote, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement("a");
        link.href = url;
        link.download = `delivery_note_${
          processedDeliveryNote.deliveryNote?.dn_no || "data"
        }.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus("JSON file downloaded successfully", "success");
      }

      // Action functions for table rows
      function viewDeliveryNote(id) {
        const note = allDeliveryNotes.find((n) => n.id === id);
        if (note) {
          const details = `
Delivery Note Details:

DN Number: ${note.dn_no || 'N/A'}
MR Number: ${note.mr_no || 'N/A'}
Site Code: ${note.site_Code || 'N/A'}
Customer: ${note.Customer || 'N/A'}
Customer PO: ${note.Customer_PO || 'N/A'}
Project Name: ${note.Project_Name || 'N/A'}
Product Manager: ${note.Product_Manager || 'N/A'}
From Warehouse: ${note.From_Warehouse || 'N/A'}
Warehouse Keeper: ${note.Warehouse_Keeper || 'N/A'}
Warehouse Tel: ${note.Warehouse_Keeper_tel || 'N/A'}
Logistics Specialist: ${note.logistics_specialist || ''}
Request Arrived Date: ${formatDisplayDate(note.request_arrived_date) || 'N/A'}
Received Location: ${note.received_location || 'N/A'}
Delivered Location: ${note.Delivered_location || 'N/A'}
Collected Location: ${note.Collected_location || 'N/A'}
Status: ${note.DN_Status || 'Created'}
Contract Info: ${note.contract_info || 'N/A'}
Created: ${formatDisplayDate(note.created_at) || 'N/A'}`;
          updateDeliveryNotesTable();
          showStatus("Delivery note deleted successfully", "success");
        }
      }
    </script>

    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
