<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="global-loader.css" />
    <link rel="stylesheet" href="location-tooltips.css" />
    <style>
      .location-icons {
        display: flex;
        gap: 4px;
        justify-content: center;
        align-items: center;
      }
      .location-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        min-width: 20px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      /* .location-btn:hover {
        transform: scale(1.05);
        border-color: #999;
      } */
      .location-btn.received {
        color: #10b981;
        border-color: #10b981;
      }
      .location-btn.delivered {
        color: #3b82f6;
        border-color: #3b82f6;
      }
      .location-btn.collected {
        color: #f59e0b;
        border-color: #f59e0b;
      }
      .location-btn ion-icon {
        font-size: 14px;
      }
      .col-locations {
        width: 80px;
        text-align: center;
      }
      .col-status {
        width: 120px;
        text-align: center;
        white-space: nowrap;
      }
      .col-dn {
        width: 150px;
        white-space: nowrap;
        overflow: visible;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .table-scroll-wrapper {
        overflow-x: auto;
        overflow-y: visible;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .delivery-notes-table {
        min-width: 1200px;
        width: 100%;
        border-collapse: collapse;
        margin: 0;
      }
      .table-scroll-wrapper::-webkit-scrollbar {
        height: 8px;
      }
      .table-scroll-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .table-scroll-wrapper::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

    </style>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
      // Browser compatibility polyfills
      if (!Array.prototype.includes) {
        Array.prototype.includes = function(searchElement) {
          return this.indexOf(searchElement) !== -1;
        };
      }
      if (!String.prototype.includes) {
        String.prototype.includes = function(search) {
          return this.indexOf(search) !== -1;
        };
      }
      if (!Object.entries) {
        Object.entries = function(obj) {
          var ownProps = Object.keys(obj), i = ownProps.length, resArray = new Array(i);
          while (i--) resArray[i] = [ownProps[i], obj[ownProps[i]]];
          return resArray;
        };
      }
    </script>
    <title>Delivery Notes - Admin</title>
  </head>
  <body>
    <nav>
      <div class="logo">
        <div class="logo-image">
          <img src="assets/logo2.png" alt="Company Logo" />
        </div>
      </div>
      <div class="menu-items">
        <ul class="navLinks">
          <li class="navList">
            <a href="dashboard.html">
              <ion-icon name="home-outline"></ion-icon>
              <span class="links">Dashboard</span>
            </a>
          </li>
          <li class="navList active">
            <a href="delivery-notes.html">
              <ion-icon name="folder-outline"></ion-icon>
              <span class="links">DN Managment</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-trip.html">
              <ion-icon name="car-sport-outline"></ion-icon>
              <span class="links">Trips Management</span>
            </a>
          </li>
          <li class="navList">
            <a href="accounting.html">
              <ion-icon name="calculator-outline"></ion-icon>
              <span class="links">Finance Management</span>
            </a>
          </li>
          <li class="nav-divider"></li>
          <li class="navList">
            <a href="add-site.html">
              <ion-icon name="location-outline"></ion-icon>
              <span class="links">Add Site</span>
            </a>
          </li>
          <li class="navList">
            <a href="add-truck.html">
              <ion-icon name="car-outline"></ion-icon>
              <span class="links">Add Truck</span>
            </a>
          </li>
          <li class="navList">
            <a href="add_item.html">
              <ion-icon name="cube-outline"></ion-icon>
              <span class="links">Add Item</span>
            </a>
          </li>
          <li class="nav-divider"></li>
          <li class="navList">
            <a href="reports.html">
              <ion-icon name="bar-chart-outline"></ion-icon>
              <span class="links">Reports</span>
            </a>
          </li>
        </ul>
        <ul class="bottom-link">
          <!-- <li>
            <a href="profile.html">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span class="links">Profile</span>
            </a>
          </li> -->
          <li>
            <a href="#" onclick="logout()">
              <ion-icon name="log-out-outline"></ion-icon>
              <span class="links">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="data-table userDetailsTable">
          <div class="title">
            <ion-icon name="folder-outline"></ion-icon>
            <span class="text">DN Managment </span>
          </div>

          <!-- Upload Section -->
          <div class="upload-section">
            <div class="upload-container">
              <button class="upload-btn" onclick="triggerFileUpload()">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                Upload Excel Sheet
              </button>
              <!-- <button class="upload-btn secondary" onclick="toggleUploadForm()">
                <ion-icon name="add-outline"></ion-icon>
                Add Delivery Note
              </button> -->

              <button
                class="upload-btn danger"
                onclick="clearAllData()"
                id="clearBtn"
                class="hidden"
              >
                <ion-icon name="trash-outline"></ion-icon>
                Clear Data
              </button>

              <div class="search-container">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search delivery notes by DN number"
                  onkeypress="handleSearchKeyPress(event)"
                />
                <button class="search-btn" onclick="performSearch()">
                  <ion-icon name="search-outline"></ion-icon>
                  Search
                </button>
                <button
                  class="back-btn"
                  onclick="goBack()"
                  id="backBtn"
                  class="hidden"
                >
                  <ion-icon name="arrow-back-outline"></ion-icon>
                  Back
                </button>
              </div>
            </div>

            <!-- Site Selection for Excel Upload -->
            <div class="upload-form">
              <h3>
                <ion-icon name="location-outline"></ion-icon>
                Select Site to add Delivery Notes
              </h3>
              <select id="excelSiteSelect" required onchange="loadDeliveryNotesBySite()">
                <option value="">Select Site First</option>
              </select>
            </div>

            <!-- Drag and Drop Area -->
            <div
              class="drag-drop-area disabled"
              onclick="triggerFileUpload()"
              id="dragDropArea"
              style="display: none;"
            >
              <input
                type="file"
                id="excelUpload"
                accept=".xlsx,.xls"
                class="hidden"
                disabled
              />
              <div class="icon">
                <ion-icon name="cloud-upload-outline"></ion-icon>
              </div>
              <div class="text">Drag and drop your Excel file here</div>
              <div class="subtext">
                or click to browse for files (.xlsx, .xls)
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Upload Status -->
            <div id="uploadStatus" class="upload-status"></div>

            <!-- Manual Upload Form -->
            <!-- <div id="uploadForm" class="upload-form hidden">
              <h3>
                <ion-icon name="add-circle-outline"></ion-icon>
                Add New Delivery Note
              </h3>
              <form id="deliveryNoteForm" onsubmit="submitDeliveryNote(event)">
                <input type="text" id="dnNo" placeholder="DN Number" required />
                <input type="text" id="mrNo" placeholder="MR Number" />
                <input
                  type="text"
                  id="customer"
                  placeholder="Customer"
                  required
                />
                <input
                  type="text"
                  id="projectName"
                  placeholder="Project Name"
                  required
                />
                <select id="siteSelect" required>
                  <option value="">Select Site</option>
                </select>
                <input
                  type="text"
                  id="siteAddress"
                  placeholder="Site Address"
                  readonly
                />
                <input
                  type="text"
                  id="contractInfo"
                  placeholder="Contract Info"
                />
                <input
                  type="text"
                  id="fromWarehouse"
                  placeholder="From Warehouse"
                />
                <input
                  type="text"
                  id="receiverName"
                  placeholder="Receiver Name"
                />
                <input type="tel" id="customerTel" placeholder="Customer Tel" />
                <textarea
                  id="purposeDelivery"
                  placeholder="Purpose of Delivery"
                  rows="3"
                ></textarea>
                <button type="submit">
                  <ion-icon name="save-outline"></ion-icon>
                  Save to Database
                </button>
                <button type="button" onclick="toggleUploadForm()">
                  <ion-icon name="close-outline"></ion-icon>
                  Cancel
                </button>
              </form>
            </div> -->

            <!-- Processed Excel Data Display -->
            <div id="excelData" class="excel-data hidden">
              <h3>
                <ion-icon name="document-text-outline"></ion-icon>
                Processed Delivery Note Data
              </h3>
              <div id="excelDataContent"></div>
              <div class="button-center">
                <button
                  class="upload-btn"
                  onclick="uploadProcessedData()"
                  id="uploadProcessedBtn"
                >
                  <ion-icon name="cloud-upload-outline"></ion-icon>
                  Upload to Database
                </button>
                <button
                  class="upload-btn secondary hidden"
                  onclick="downloadJSON()"
                  id="downloadJsonBtn"
                  style="display: none;"
                >
                  <ion-icon name="download-outline"></ion-icon>
                  Download JSON
                </button>
              </div>
            </div>
          </div>

          <!-- Error Messages -->
          <div id="errorMessage" class="upload-status error hidden"></div>

          <!-- Delivery Notes Table -->
          <div class="table-container">
            <div class="table-header">
              <ion-icon name="list-outline"></ion-icon>
              <span id="tableTitle">All Delivery Notes</span>
            </div>
            <div class="table-scroll-wrapper">
              <table class="delivery-notes-table">
              <thead>
                <tr>
                  <th class="col-dn">DN No</th>
                  <th class="col-site">Site</th>
                  <th class="col-project">Project</th>
                  <th class="col-manager">Manager</th>
                  <th class="col-warehouse">Warehouse</th>
                  <th class="col-date">Date</th>
                  <th class="col-status">Status</th>
                  <th class="col-locations">Locations</th>
                  <th class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody id="deliveryNotesTableBody">
                <tr>
                  <td colspan="11" class="empty-state">
                    <ion-icon name="document-outline" class="empty-icon"></ion-icon>
                    <br>Loading delivery notes...
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr id="paginationRow" style="display: none;">
                  <td colspan="9" style="text-align: center; padding: 15px; background: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <div id="pagination" style="display: flex; justify-content: center; align-items: center; gap: 15px;">
                      <button id="prevBtn" onclick="changeTablePage(-1)" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Previous</button>
                      <span id="pageInfo" style="font-weight: 500;"></span>
                      <button id="nextBtn" onclick="changeTablePage(1)" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Next</button>
                    </div>
                  </td>
                </tr>
              </tfoot>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/browser-compat.js"></script>

    <script>
      // Check authentication
      if (!sessionStorage.getItem('userRole') || sessionStorage.getItem('userRole') !== 'admin') {
        window.location.href = 'index.html';
      }

      // Global variables
      let processedDeliveryNote = null;
      let allDeliveryNotes = [];
      let currentView = "all";
      let currentPage = 1;
      let totalPages = 1;
      let currentSiteCode = '';
      let showingAll = false;

      // DOM elements
      const fileInput = document.getElementById("excelUpload");
      const dragDropArea = document.getElementById("dragDropArea");
      const uploadStatus = document.getElementById("uploadStatus");
      const excelData = document.getElementById("excelData");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const searchInput = document.getElementById("searchInput");
      const backBtn = document.getElementById("backBtn");
      const clearBtn = document.getElementById("clearBtn");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        initializeEventListeners();
        loadSites();
        loadAllDeliveryNotes();
      });

      async function loadAllDeliveryNotes() {
        globalLoader.show('Loading delivery notes...');
        
        currentPage = 1;
        showingAll = true;
        
        try {
          const response = await fetch('api/get-delivery-notes.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ show_all: true })
          });
          
          if (!response.ok) {
            globalLoader.hide();
            return;
          }
          const result = await response.json();
          
          if (result.success) {
            allDeliveryNotes = result.data;
            updateDeliveryNotesTable();
            document.getElementById('tableTitle').textContent = `All Delivery Notes (${result.data.length})`;
          }
          globalLoader.hide();
        } catch (error) {
          globalLoader.hide();
          globalLoader.showMessage('Error loading delivery notes', 'error');
        }
      }
      
      function updatePaginationDisplay(result) {
        const pagination = document.getElementById('pagination');
        
        if (result.total > 10) {
          pagination.innerHTML = `
            <button onclick="changePage(-1)" ${result.page <= 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${result.page} of ${result.totalPages}</span>
            <button onclick="changePage(1)" ${result.page >= result.totalPages ? 'disabled' : ''}>Next</button>
          `;
          pagination.style.display = 'flex';
        } else {
          pagination.style.display = 'none';
        }
      }
      
      function changePage(direction) {
        currentPage += direction;
        loadAllDeliveryNotes();
      }
      
      function changeTablePage(direction) {
        currentPage += direction;
        updateDeliveryNotesTable();
      }
      
      function navigateNote(currentIndex, direction) {
        const newIndex = currentIndex + direction;
        const totalNotes = allDeliveryNotes.length;
        
        if (newIndex < 0 || newIndex >= totalNotes) return;
        
        // Calculate which page the target note is on
        const targetPage = Math.floor(newIndex / 10) + 1;
        
        if (targetPage !== currentPage) {
          currentPage = targetPage;
          updateDeliveryNotesTable();
        }
        
        // Highlight the target row
        setTimeout(() => {
          const rows = document.querySelectorAll('#deliveryNotesTableBody tr');
          const targetRowIndex = newIndex % 10;
          if (rows[targetRowIndex]) {
            rows[targetRowIndex].style.backgroundColor = '#e3f2fd';
            setTimeout(() => rows[targetRowIndex].style.backgroundColor = '', 1000);
          }
        }, 100);
      }

      async function loadDeliveryNotesBySite() {
        const siteCode = document.getElementById('excelSiteSelect').value;
        if (!siteCode) {
          loadAllDeliveryNotes();
          return;
        }
        
        globalLoader.show(`Loading delivery notes for ${siteCode}...`);
        
        currentSiteCode = siteCode;
        currentPage = 1;
        showingAll = true;
        
        await fetchDeliveryNotes();
      }

      async function fetchDeliveryNotes() {
        try {
          showError('');
          const limit = showingAll ? 100 : 10;
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          
          const response = await fetch('api/get-delivery-notes-by-site.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ site_code: currentSiteCode, page: currentPage, limit: limit }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          console.log('API Response:', result);
          
          if (result.success) {
            allDeliveryNotes = result.data;
            totalPages = result.totalPages;
            updateDeliveryNotesTable();
            updatePagination(result);
            document.getElementById('tableTitle').textContent = `Delivery Notes for Site: ${currentSiteCode}`;
          } else {
            throw new Error(result.error);
          }
          globalLoader.hide();
        } catch (error) {
          globalLoader.hide();
          if (error.name === 'AbortError') {
            globalLoader.showMessage('Request timeout - please try again', 'error');
          } else {
            globalLoader.showMessage('Error loading delivery notes: ' + error.message, 'error');
          }
          document.getElementById('deliveryNotesTableBody').innerHTML = `
            <tr>
              <td colspan="10" class="empty-state">
                <ion-icon name="warning-outline" class="empty-icon"></ion-icon>
                <br>Failed to load delivery notes
              </td>
            </tr>
          `;
        }
      }

      function resetTable() {
        document.getElementById('deliveryNotesTableBody').innerHTML = `
          <tr>
            <td colspan="17" class="empty-state">
              <ion-icon name="location-outline" class="empty-icon"></ion-icon>
              <br>Select a site to add delivery notes
            </td>
          </tr>
        `;
        document.getElementById('tableTitle').textContent = 'Select a site to add delivery notes';
        document.getElementById('pagination').style.display = 'none';
      }

      function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          fetchDeliveryNotes();
        }
      }

      function showAllNotes() {
        showingAll = true;
        currentPage = 1;
        fetchDeliveryNotes();
      }

      function updatePagination(result) {
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (result.total > 0) {
          pagination.style.display = 'flex';
          pageInfo.textContent = showingAll ? 
            `Showing all ${result.total} notes` : 
            `Page ${result.page} of ${result.totalPages} (${result.total} total)`;
          prevBtn.disabled = result.page <= 1 || showingAll;
          nextBtn.disabled = result.page >= result.totalPages || showingAll;
        } else {
          pagination.style.display = 'none';
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        if (message) {
          errorDiv.textContent = message;
          errorDiv.classList.remove('hidden');
          setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        } else {
          errorDiv.classList.add('hidden');
        }
      }

      async function loadSites() {
        try {
          const response = await fetch('api/get-sites.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();
          
          if (result.success) {
            // Load sites for form dropdown
            const siteSelect = document.getElementById('siteSelect');
            if (siteSelect) {
              siteSelect.innerHTML = '<option value="">Select Site</option>';
              result.data.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_Code;
                option.textContent = `${site.site_Code} - ${site.Site_Name}`;
                option.dataset.address = site.Address || '';
                siteSelect.appendChild(option);
              });
            }
            
            // Load sites for Excel upload dropdown
            const excelSiteSelect = document.getElementById('excelSiteSelect');
            if (excelSiteSelect) {
              excelSiteSelect.innerHTML = '<option value="">Select Site First</option>';
              result.data.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_Code;
                option.textContent = `${site.site_Code} - ${site.Site_Name}`;
                option.dataset.address = site.Address || '';
                excelSiteSelect.appendChild(option);
              });
            }
          }
        } catch (error) {
          console.error('Error loading sites:', error);
        }
      }

      document.addEventListener('change', function(e) {
        if (e.target.id === 'siteSelect') {
          const selectedOption = e.target.options[e.target.selectedIndex];
          const siteAddress = document.getElementById('siteAddress');
          siteAddress.value = selectedOption.dataset.address || '';
        }
        
        if (e.target.id === 'excelSiteSelect') {
          const dragDropArea = document.getElementById('dragDropArea');
          const fileInput = document.getElementById('excelUpload');
          
          if (e.target.value) {
            // Show and enable upload when site is selected
            dragDropArea.style.display = 'block';
            dragDropArea.classList.remove('disabled');
            fileInput.disabled = false;
          } else {
            // Hide upload when no site selected
            dragDropArea.style.display = 'none';
            dragDropArea.classList.add('disabled');
            fileInput.disabled = true;
          }
        }
      });

      function initializeEventListeners() {
        // File input handling
        fileInput.addEventListener("change", handleFileSelect);

        // Drag and drop
        dragDropArea.addEventListener("dragover", handleDragOver);
        dragDropArea.addEventListener("dragleave", handleDragLeave);
        dragDropArea.addEventListener("drop", handleFileDrop);

        // Prevent default drag behaviors on document
        document.addEventListener("dragover", (e) => e.preventDefault());
        document.addEventListener("drop", (e) => e.preventDefault());
      }

      // File handling functions
      function triggerFileUpload() {
        const excelSiteSelect = document.getElementById('excelSiteSelect');
        if (!excelSiteSelect.value) {
          showStatus('❌ Please select a site first before uploading Excel file', 'error');
          return;
        }
        fileInput.click();
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          processExcelFile(file);
        }
      }

      function handleDragOver(event) {
        event.preventDefault();
        dragDropArea.classList.add("dragover");
      }

      function handleDragLeave(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");
      }

      function handleFileDrop(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          processExcelFile(files[0]);
        }
      }

      // Excel processing functions
      function processExcelFile(file) {
        if (!validateFile(file)) return;

        console.log('Processing Excel file:', file.name, 'Size:', file.size);
        showStatus("📊 Processing Excel file...", "processing", true);
        updateProgress(10);

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            console.log('File read successfully, processing...');
            updateProgress(30);
            
            const data = new Uint8Array(e.target.result);
            console.log('Data array created, length:', data.length);
            
            const workbook = XLSX.read(data, {
              type: "array",
              cellStyles: true,
              cellFormulas: true,
              cellDates: true,
            });

            console.log('Workbook loaded, sheets:', workbook.SheetNames);
            updateProgress(50);

            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
              throw new Error('No sheets found in Excel file');
            }

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            console.log('Processing sheet:', firstSheetName);

            updateProgress(70);

            const extractedData = extractDeliveryNoteData(workbook);
            console.log('Data extracted:', extractedData);
            
            // Ensure delivery note is assigned to selected site
            const selectedSiteCode = document.getElementById('excelSiteSelect').value;
            if (selectedSiteCode) {
              extractedData.deliveryNote.site_Code = selectedSiteCode;
              
              // Update items with selected site code
              extractedData.items.forEach(item => {
                item.site_code = selectedSiteCode;
              });
            }

            updateProgress(90);

            processedDeliveryNote = extractedData;
            displayExcelData(extractedData.deliveryNote, extractedData.items);

            updateProgress(100);
            showStatus(
              "✅ Excel file processed successfully! Review data and upload to database.",
              "success"
            );
          } catch (error) {
            console.error("Error processing file:", error);
            showStatus(
              "❌ Error processing Excel file: " + error.message,
              "error"
            );
            updateProgress(0);
          }
        };

        reader.onerror = function (error) {
          console.error('FileReader error:', error);
          showStatus("❌ Error reading file. Please try again.", "error");
          updateProgress(0);
        };

        reader.readAsArrayBuffer(file);
      }

      function validateFile(file) {
        if (!file.name.match(/\.(xlsx|xls)$/i)) {
          showStatus(
            "❌ Please select a valid Excel file (.xlsx or .xls)",
            "error"
          );
          return false;
        }

        if (file.size > 10 * 1024 * 1024) {
          showStatus(
            "❌ File size too large. Please select a file smaller than 10MB",
            "error"
          );
          return false;
        }

        return true;
      }

      function extractDeliveryNoteData(workbook) {
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const getCellValue = (cellRefs) => {
          const refs = Array.isArray(cellRefs) ? cellRefs : [cellRefs];
          for (const cellRef of refs) {
            const cell = worksheet[cellRef];
            if (cell && cell.v !== undefined && cell.v !== "") {
              const value = String(cell.v).trim();
              return value === "" ? null : value;
            }
          }
          return null;
        };

        const deliveryNote = {
          print_date: formatDateTime(getCellValue(["B2", "A2"])) || getCurrentDateTime(),
          purpose_of_delivery: getCellValue(["C3", "D3", "E3"]),
          delivery_address: getCellValue(["C4", "D4", "E4"]),
          site_Code: getCellValue(["C5", "D5", "E5"]),
          contract_info: getCellValue(["C6", "D6", "E6"]),
          Customer: getCellValue(["K8","08"]),
          Customer_PO: getCellValue(["O8", "O8"]),
          Customer_Tel: getCellValue(["M4", "L4"]),
          Project_Name: getCellValue(["C7", "D7", "E7"]),
          Project_Code: getCellValue(["O7", "O7"]),
          Product_Category: getCellValue(["C8", "D8", "E8"]),
          Product_Manager: getCellValue(["K9","09"]),
          Special_Unloading_Req: getCellValue(["C9", "D9", "E9"]),
          Installation_Environment: getCellValue(["C10", "D10", "E10"]),
          Description_MR: getCellValue(["C11", "D11", "E11"]),
          From_Warehouse: getCellValue(["C12", "D12", "E12"]),
          Warehouse_Keeper: getCellValue(["G12", "H12"]),
          Warehouse_Keeper_tel: getCellValue(["O12", "O12"]),
          Description_DN: getCellValue(["C13", "D13", "E13"]),
          Including_dangerous_goods: getCellValue(["C14", "D14", "E14"]) || "No",
          pickup_address: getCellValue(["K3", "03"]),
          Site_Address: getCellValue(["K4","04"]),
          dn_no: getCellValue(["O1", "N1", "P1"]) || generateDNNumber(),
          mr_no: getCellValue(["O2", "N2", "P2"]),
          receiver_name: getCellValue(["O3", "03"]),
          receiver_tel: getCellValue(["O4", "04"]),
          Receiver_Company_Name: getCellValue(["M10", "N10", "O10"]),
          request_arrived_date: formatDateTime(getCellValue(["K5", "05"])),
          request_shipment_date: formatDateTime(getCellValue(["O5", "05"])),
          logistics_specialist: getCellValue(["K6", "06"]),
          logistics_specialist_Tel: getCellValue(["O6", "06"]),
          // received_location: getCellValue(["G13", "H13"]),
          // received_Auto_location: getCellValue(["G14", "H14"]),
          // Collected_location: getCellValue(["G15", "H15"]),
         // Collected_Auto_location: getCellValue(["G16", "H16"]),
          Company_code: '1000'
        };

        // Extract items from second sheet only
        const items = workbook.SheetNames.length > 1 ? 
          extractItemsFromSheet(workbook.Sheets[workbook.SheetNames[1]], deliveryNote.dn_no, deliveryNote.site_Code) : [];
        
        return { deliveryNote, items };
      }

      function extractItemsFromSheet(worksheet, dnNo, siteCode) {
        const items = [];
        const errors = [];
        
        console.log('Extracting items from second sheet...');
        
        if (!worksheet || !worksheet['!ref']) {
          console.log('No second sheet or invalid sheet reference');
          return items;
        }
        
        const getCellValue = (cellRef) => {
          const cell = worksheet[cellRef];
          if (cell && cell.v !== undefined) {
            const value = cell.w ? String(cell.w).trim() : String(cell.v).trim();
            return value === "" ? null : value;
          }
          return null;
        };
        
        // Get the last row number from sheet reference
        const range = worksheet['!ref'];
        const lastRow = parseInt(range.split(':')[1].replace(/[A-Z]/g, ''));
        console.log('Processing rows 2 to', lastRow);
        
        // Extract items from rows 2 to last row
        for (let row = 2; row <= lastRow; row++) {
          const itemCode = getCellValue(`E${row}`);
          const qty = getCellValue(`F${row}`); 
          const description = getCellValue(`G${row}`);
          
          console.log(`Row ${row}: Code=${itemCode}, Qty=${qty}, Desc=${description}`);
          
          // Skip header rows
          if (itemCode && (itemCode.toLowerCase().includes('item') || itemCode.toLowerCase().includes('code'))) {
            console.log(`Skipping header row ${row}`);
            continue;
          }
          
          // Skip completely empty rows
          if (!itemCode && !qty && !description) {
            continue;
          }
          
          // Validate item code length (max 15 characters)
          if (itemCode && itemCode.length > 15) {
            errors.push(`Row ${row}: Item code "${itemCode}" exceeds 15 characters`);
            continue;
          }
          
          items.push({
            dn_no: dnNo,
            site_code: siteCode, 
            item_code: itemCode,
            qty: qty ? parseFloat(qty) : null,
            item_description: description,
            Company_code: '1000'
          });
        }
        
        console.log('Extracted items:', items.length);
        
        // Show validation errors if any
        if (errors.length > 0) {
          showStatus(`⚠️ Validation errors found:\n${errors.join('\n')}`, 'error');
        }
        
        return items;
      }

      function getCellValueByRef(worksheet, cellRef) {
        const cell = worksheet[cellRef];
        if (cell && cell.v !== undefined) {
          // Use formatted value (cell.w) if available, otherwise raw value (cell.v)
          return cell.w ? String(cell.w).trim() : String(cell.v).trim();
        }
        return '';
      }

      // Utility functions
      function formatDateTime(dateValue) {
        if (!dateValue) return null;

        if (typeof dateValue === "string") {
          if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) return dateValue;

          const parsedDate = new Date(dateValue);
          if (!isNaN(parsedDate.getTime())) {
            return parsedDate.toISOString().slice(0, 19).replace("T", " ");
          }
        }

        if (typeof dateValue === "number") {
          try {
            const excelDate = XLSX.SSF.parse_date_code(dateValue);
            if (excelDate) {
              return `${excelDate.y}-${String(excelDate.m).padStart(
                2,
                "0"
              )}-${String(excelDate.d).padStart(2, "0")} 00:00:00`;
            }
          } catch (e) {
            console.warn("Date parsing error:", e);
          }
        }

        return null;
      }

      function getCurrentDateTime() {
        return new Date().toISOString().slice(0, 19).replace("T", " ");
      }

      function generateDNNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const random = Math.floor(Math.random() * 10000)
          .toString()
          .padStart(4, "0");
        return `KSD${year}${month}${day}${random}`;
      }

      // Display functions
      function showStatus(message, type = "success", showSpinner = false) {
        const spinner = showSpinner
          ? '<div class="loading-spinner"></div>'
          : "";
        uploadStatus.innerHTML = `${spinner}${message}`;
        uploadStatus.className = `upload-status ${type}`;
        uploadStatus.style.display = "block";

        if (!showSpinner && type === "success") {
          setTimeout(() => {
            uploadStatus.style.display = "none";
          }, 5000);
        }
      }

      function updateProgress(percentage) {
        progressBar.style.display = "block";
        progressFill.style.width = percentage + "%";

        if (percentage >= 100) {
          setTimeout(() => {
            progressBar.style.display = "none";
          }, 1000);
        }
      }

      function displayExcelData(deliveryNote, items) {
        let html = `
          <div class="extraction-sections">
            <div class="delivery-note-section">
              <h4><ion-icon name="document-text-outline"></ion-icon> Delivery Note (Sheet 1)</h4>
              <div class="data-grid">
        `;

        const fieldLabels = {
          print_date: "Print Date", dn_no: "DN Number", mr_no: "MR Number",
          Customer: "Customer", Project_Name: "Project Name", site_Code: "Site Code",
          From_Warehouse: "From Warehouse", Product_Manager: "Product Manager"
        };

        for (const [key, value] of Object.entries(deliveryNote)) {
          const label = fieldLabels[key] || key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
          const displayValue = (value === null || value === undefined || value === '') ? 'null' : value;
          html += `
            <div class="data-item">
              <strong>${label}</strong>
              <span>${displayValue}</span>
            </div>
          `;
        }

        html += '</div></div>';
        
        // Add items section
        html += `
          <div class="items-section">
            <h4><ion-icon name="cube-outline"></ion-icon> Items (Sheet 2) - ${items.length} items</h4>
        `;
        
        if (items && items.length > 0) {
          html += '<div class="items-table-container"><table class="items-table"><thead><tr><th>Item Description</th><th>QTY</th><th>Item Code</th><th>Status</th></tr></thead><tbody>';
          items.forEach((item, index) => {
            html += `
              <tr>
                <td class="description-cell" title="${item.item_description || 'null'}">${item.item_description || 'null'}</td>
                <td>${item.qty !== null ? item.qty : 'null'}</td>
                <td><strong>${item.item_code || 'null'}</strong></td>
                <td><span class="status-badge status-created">Created</span></td>
              </tr>
            `;
          });
          html += '</tbody></table></div>';
        } else {
          html += '<div class="no-items">No items found in second sheet</div>';
        }
        
        html += '</div></div>';
        
        document.getElementById("excelDataContent").innerHTML = html;
        excelData.style.display = "block";
        clearBtn.style.display = "inline-flex";
      }

      // Form handling
      function toggleUploadForm() {
        const form = document.getElementById("uploadForm");
        form.style.display = form.style.display === "none" ? "block" : "none";

        if (form.style.display === "block") {
          document.getElementById("dnNo").focus();
        }
      }

      function submitDeliveryNote(event) {
        event.preventDefault();

        const formData = {
          dn_no: document.getElementById("dnNo").value,
          Customer: document.getElementById("customer").value,
          Project_Name: document.getElementById("projectName").value,
          Site_Address: document.getElementById("siteAddress").value,
          site_Code: document.getElementById("siteSelect").value,
          Customer_PO: document.getElementById("customerPO").value || "",
          Customer_Tel: document.getElementById("customerTel").value || "",
          Project_Code: document.getElementById("projectCode").value ,
          Product_Category:
            document.getElementById("productCategory").value || "",
          Product_Manager:
            document.getElementById("productManager").value,
          receiver_name: document.getElementById("receiverName").value,
          receiver_tel: document.getElementById("receiverTel").value,
          Receiver_Company_Name:
            document.getElementById("receiverCompany").value || "",
        };

        uploadToDatabase(formData);
      }

      // Database operations
      async function uploadProcessedData() {
        if (!processedDeliveryNote) {
          showStatus("❌ No data to upload", "error");
          return;
        }

        await uploadToDatabase(processedDeliveryNote.deliveryNote, processedDeliveryNote.items);
      }

      async function uploadToDatabase(deliveryNote, items = []) {
        try {
          console.log('Starting database upload...');
          console.log('Delivery Note:', deliveryNote);
          console.log('Items:', items);
          
          globalLoader.show("Uploading to database...");

          const payload = { deliveryNote, items };
          console.log('Payload to send:', JSON.stringify(payload, null, 2));

          const response = await fetch("api/upload-delivery-note.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(payload),
          });

          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('HTTP Error Response:', errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
          }

          const responseText = await response.text();
          console.log('Raw response:', responseText);
          
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            throw new Error('Invalid JSON response from server: ' + responseText);
          }
          
          console.log('Parsed result:', result);
          globalLoader.hide();

          if (result.success) {
            globalLoader.showMessage(
              `Successfully uploaded! DN: ${result.dn_no || deliveryNote.dn_no} with ${items.length} items`,
              "success"
            );

            // Auto-load new delivery notes into table
            if (currentSiteCode) {
              // If viewing specific site, refresh that site's notes
              if (currentSiteCode === deliveryNote.site_Code) {
                await fetchDeliveryNotes();
              }
            } else {
              // If viewing all notes, refresh all notes
              await loadAllDeliveryNotes();
            }

            // Reset forms
            clearExcelData();
            if (document.getElementById("deliveryNoteForm")) {
              document.getElementById("deliveryNoteForm").reset();
            }
          } else {
            console.error('Upload failed:', result.error);
            // Check for duplicate error
            if (result.error && result.error.toLowerCase().includes('duplicate')) {
              globalLoader.showMessage(
                `❌ Duplicate delivery note! DN: ${deliveryNote.dn_no} already exists in the database.`,
                "error"
              );
            } else {
              throw new Error(result.error || "Upload failed");
            }
          }
        } catch (error) {
          console.error('Upload error:', error);
          globalLoader.hide();
          
          let errorMessage = "Upload failed: ";
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            errorMessage += "Cannot connect to server.";
          } else {
            errorMessage += error.message;
          }

          globalLoader.showMessage(errorMessage, "error");
        }
      }

      async function loadDeliveryNotes() {
        try {
          const response = await fetch("api/get-delivery-notes.php");
          const result = await response.json();

          if (result.success) {
            allDeliveryNotes = result.data;
            updateDeliveryNotesTable();
          } else {
            console.error("Error loading delivery notes:", result.error);
            updateDeliveryNotesTable();
          }
        } catch (error) {
          console.error("Error:", error);
          updateDeliveryNotesTable();
        }
      }

      function updateDeliveryNotesTable(notesToShow = null) {
        const tbody = document.getElementById("deliveryNotesTableBody");
        const notes = notesToShow || allDeliveryNotes;

        if (notes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="empty-state">
                <ion-icon name="document-outline" class="empty-icon"></ion-icon>
                <br>No delivery notes found
              </td>
            </tr>
          `;
          return;
        }

        // Client-side pagination - show only 10 per page
        const itemsPerPage = 10;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedNotes = notes.slice(startIndex, endIndex);
        
        // Update pagination controls
        totalPages = Math.ceil(notes.length / itemsPerPage);
        const paginationRow = document.getElementById('paginationRow');
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (notes.length > 10) {
          pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${notes.length} total)`;
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= totalPages;
          paginationRow.style.display = 'table-row';
        } else {
          paginationRow.style.display = 'none';
        }

        tbody.innerHTML = paginatedNotes
          .map(
            (note) => `
          <tr>
            <td class="col-dn"><strong>${note.dn_no || "N/A"}</strong></td>
            <td class="col-site">${note.site_Code || "N/A"}</td>
            <td class="col-project" title="${note.Project_Name || "N/A"}">${truncateText(note.Project_Name || "N/A", 25)}</td>
            <td class="col-manager" title="${note.Product_Manager || "N/A"}">${truncateText(note.Product_Manager || "N/A", 15)}</td>
            <td class="col-warehouse" title="${note.From_Warehouse || "N/A"}">${truncateText(note.From_Warehouse || "N/A", 15)}</td>
            <td class="col-date">${formatDisplayDate(note.request_arrived_date) || "N/A"}</td>
            <td class="col-status"><span class="status-badge status-${(
              note.DN_Status || "created"
            ).toLowerCase()}">${note.DN_Status || "Created"}</span></td>
            <td class="col-locations">
              <div class="location-icons">
                <button class="location-btn received" onclick="openLocation('${note.received_location || ''}', 'Received')" title="Received location">
                  <ion-icon name="location" style="pointer-events: none;"></ion-icon>
                </button>
                <button class="location-btn delivered" onclick="openLocation('${note.delivered_location || ''}', 'Delivered')" title="Delivered location">
                  <ion-icon name="location" style="pointer-events: none;"></ion-icon>
                </button>
                <button class="location-btn collected" onclick="openLocation('${note.collected_location || ''}', 'Collected')" title="Collected location">
                  <ion-icon name="location" style="pointer-events: none;"></ion-icon>
                </button>
              </div>
            </td>
            <td class="col-actions">
              <div class="action-buttons">
                <button class="action-btn view" onclick="viewDeliveryNoteItems('${note.dn_no}')" title="View">
                  <ion-icon name="eye-outline" style="pointer-events: none;"></ion-icon>
                </button>
                <button class="action-btn delete" onclick="deleteDeliveryNote(${
                  note.id
                })" title="Delete">
                  <ion-icon name="trash-outline" style="pointer-events: none;"></ion-icon>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Utility functions for table
      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }

      function formatDisplayDate(dateString) {
        if (!dateString) return "N/A";
        try {
          const date = new Date(dateString);
          return (
            date.toLocaleDateString() +
            " " +
            date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
          );
        } catch {
          return dateString;
        }
      }

      // Search and filter functions
      function handleSearchKeyPress(event) {
        if (event.key === "Enter") {
          performSearch();
        }
      }

      function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          showStatus("Please enter a search term", "error");
          return;
        }

        const filteredNotes = allDeliveryNotes.filter(
          (note) =>
            (note.dn_no && note.dn_no.toLowerCase().includes(searchTerm)) ||
            (note.customer &&
              note.customer.toLowerCase().includes(searchTerm)) ||
            (note.project_name &&
              note.project_name.toLowerCase().includes(searchTerm)) ||
            (note.site_address &&
              note.site_address.toLowerCase().includes(searchTerm)) ||
            (note.mr_no && note.mr_no.toLowerCase().includes(searchTerm))
        );

        updateDeliveryNotesTable(filteredNotes);
        backBtn.style.display = "inline-flex";
        currentView = "search";

        showStatus(
          `Found ${filteredNotes.length} delivery note(s) matching "${searchTerm}"`,
          "success"
        );
      }

      function goBack() {
        searchInput.value = "";
        backBtn.style.display = "none";
        currentView = "all";
        if (currentSiteCode) {
          fetchDeliveryNotes();
        } else {
          resetTable();
        }
        showStatus("Showing all delivery notes", "success");
      }

      // Additional functions
      async function showSavedExcelSheets() {
        if (!currentSiteCode) {
          showError('Please select a site first to add delivery notes');
          return;
        }
        
        showingAll = true;
        currentPage = 1;
        await fetchDeliveryNotes();
      }

      function clearExcelData() {
        processedDeliveryNote = null;
        excelData.style.display = "none";
        clearBtn.style.display = "none";
        fileInput.value = "";
        showStatus("Excel data cleared", "success");
      }

      function clearAllData() {
        if (
          confirm(
            "Are you sure you want to clear all processed data? This will not affect the database."
          )
        ) {
          clearExcelData();
          document.getElementById("deliveryNoteForm").reset();
          toggleUploadForm();
        }
      }

      function downloadJSON() {
        if (!processedDeliveryNote) {
          showStatus("No data to download", "error");
          return;
        }

        const dataStr = JSON.stringify(processedDeliveryNote, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement("a");
        link.href = url;
        link.download = `delivery_note_${
          processedDeliveryNote.deliveryNote?.dn_no || "data"
        }.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus("JSON file downloaded successfully", "success");
      }

      // Action functions for table rows
      async function viewDeliveryNoteItems(dnNo) {
        try {
          const response = await fetch('api/get-dn-items.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dn_no: dnNo })
          });
          
          const result = await response.json();
          
          if (result.success && result.data.length > 0) {
            let itemsHtml = `<h3>Items for DN: ${dnNo}</h3><table style="width:100%; border-collapse: collapse;"><thead><tr><th style="border:1px solid #ddd; padding:8px;">Item Code</th><th style="border:1px solid #ddd; padding:8px;">Description</th><th style="border:1px solid #ddd; padding:8px;">Quantity</th></tr></thead><tbody>`;
            
            result.data.forEach(item => {
              itemsHtml += `<tr><td style="border:1px solid #ddd; padding:8px;">${item.item_code || 'N/A'}</td><td style="border:1px solid #ddd; padding:8px;">${item.item_description || 'N/A'}</td><td style="border:1px solid #ddd; padding:8px;">${item.qty || 0}</td></tr>`;
            });
            
            itemsHtml += '</tbody></table>';
            
            const popup = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            popup.document.write(`<html><head><title>Items - ${dnNo}</title><style>body{font-family:Arial,sans-serif;padding:20px;}table{margin-top:20px;}th{background:#f5f5f5;}</style></head><body>${itemsHtml}</body></html>`);
            popup.document.close();
          } else {
            alert(`No items found for DN: ${dnNo}`);
          }
        } catch (error) {
          alert('Error loading items: ' + error.message);
        }
      }
      
      async function deleteDeliveryNote(id) {
        if (!confirm('Are you sure you want to delete this delivery note?')) return;
        
        try {
          const response = await fetch('api/delete-delivery-note.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Delivery note deleted successfully');
            if (currentSiteCode) {
              await fetchDeliveryNotes();
            } else {
              await loadAllDeliveryNotes();
            }
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error deleting delivery note: ' + error.message);
        }
      }
      
      function openLocation(locationUrl, locationType) {
        if (!locationUrl || locationUrl.trim() === '') {
          alert(`No ${locationType} location available for this delivery note.`);
          return;
        }
        
        // Check if URL starts with http/https, if not add https://
        let url = locationUrl.trim();
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        
        window.open(url, '_blank');
      }
    </script>

    <script src="js/global-loader.js"></script>
    <script src="js/session.js"></script>
  </body>
</html>