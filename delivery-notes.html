<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Delivery Notes - Admin</title>
    <style>
     
      .upload-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .upload-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
      }

      .upload-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .upload-btn.secondary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .upload-btn.danger {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      }

      .search-container {
        display: flex;
        gap: 10px;
        align-items: center;
        flex: 1;
        min-width: 300px;
      }

      .search-container input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .search-container input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-btn,
      .back-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .search-btn:hover,
      .back-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }

      .upload-status {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        display: none;
      }

      .upload-status.success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .upload-status.error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .upload-status.processing {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .upload-form {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid #e9ecef;
      }

      .upload-form h3 {
        color: #495057;
        margin-bottom: 20px;
        font-size: 1.4em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .upload-form form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
      }

      .upload-form input,
      .upload-form textarea {
        padding: 12px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .upload-form input:focus,
      .upload-form textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .upload-form button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .upload-form button[type="submit"] {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .upload-form button[type="button"] {
        background: #6c757d;
        color: white;
      }

      .excel-data {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 600px;
        overflow-y: auto;
      }

      .excel-data h3 {
        color: #495057;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.4em;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .data-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        transition: transform 0.2s ease;
      }

      .data-item:hover {
        transform: translateX(5px);
      }

      .data-item strong {
        color: #495057;
        display: block;
        margin-bottom: 8px;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-item span {
        color: #6c757d;
        word-break: break-word;
        font-size: 0.95em;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin: 15px 0;
        display: none;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
      }

      .table-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        font-size: 1.2em;
        font-weight: 500;
      }

      .delivery-notes-table {
        width: 100%;
        border-collapse: collapse;
      }

      .delivery-notes-table th,
      .delivery-notes-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .delivery-notes-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .delivery-notes-table tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-created {
        background: #fff3cd;
        color: #856404;
      }

      .status-received {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-delivered {
        background: #d4edda;
        color: #155724;
      }

      .status-collected {
        background: #e2e3e5;
        color: #383d41;
      }

      .status-closed {
        background: #f8d7da;
        color: #721c24;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .action-btn.edit {
        background: #ffc107;
        color: #212529;
      }

      .action-btn.delete {
        background: #dc3545;
        color: white;
      }

      .action-btn.view {
        background: #17a2b8;
        color: white;
      }

      .drag-drop-area {
        border: 3px dashed #dee2e6;
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
      }

      .drag-drop-area:hover,
      .drag-drop-area.dragover {
        border-color: #667eea;
        background: #f0f8ff;
        transform: translateY(-2px);
      }

      .drag-drop-area .icon {
        font-size: 3em;
        color: #667eea;
        margin-bottom: 15px;
      }

      .drag-drop-area .text {
        font-size: 1.1em;
        color: #6c757d;
        margin-bottom: 10px;
      }

      .drag-drop-area .subtext {
        font-size: 0.9em;
        color: #adb5bd;
      }

      @media (max-width: 768px) {
        .upload-container {
          flex-direction: column;
          align-items: stretch;
        }

        .search-container {
          min-width: auto;
        }

        .data-grid {
          grid-template-columns: 1fr;
        }

        .upload-form form {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="logo">
        <div class="logo-image">
          <img src="" alt="" />
        </div>
      </div>
      <div class="menu-items">
        <ul class="navLinks">
          <li class="navList">
            <a href="dashboard.html">
              <ion-icon name="home-outline"></ion-icon>
              <span class="links">Dashboard</span>
            </a>
          </li>
          <li class="navList active">
            <a href="delivery-notes.html">
              <ion-icon name="folder-outline"></ion-icon>
              <span class="links">Delivery notes</span>
            </a>
          </li>
         <li class="navList">
                    <a href="add-site.html">
                        <ion-icon name="location-outline"></ion-icon>
                        <span class="links">Add Site</span>
                    </a>
                </li>
        </ul>
        <ul class="bottom-link">
          <li>
            <a href="profile.html">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span class="links">Profile</span>
            </a>
          </li>
          <li>
            <a href="index.html">
              <ion-icon name="log-out-outline"></ion-icon>
              <span class="links">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="data-table userDetailsTable">
          <div class="title">
            <ion-icon name="folder-outline"></ion-icon>
            <span class="text">Delivery Notes Management</span>
          </div>

          <!-- Upload Section -->
          <div class="upload-section">
            <div class="upload-container">
              <button class="upload-btn" onclick="triggerFileUpload()">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                Upload Excel Sheet
              </button>
              <button class="upload-btn secondary" onclick="toggleUploadForm()">
                <ion-icon name="add-outline"></ion-icon>
                Add Delivery Note
              </button>
              <button class="upload-btn" onclick="showSavedExcelSheets()">
                <ion-icon name="list-outline"></ion-icon>
                Show All Notes
              </button>
              <button
                class="upload-btn danger"
                onclick="clearAllData()"
                id="clearBtn"
                style="display: none"
              >
                <ion-icon name="trash-outline"></ion-icon>
                Clear Data
              </button>

              <div class="search-container">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search delivery notes by DN, customer, project..."
                  onkeypress="handleSearchKeyPress(event)"
                />
                <button class="search-btn" onclick="performSearch()">
                  <ion-icon name="search-outline"></ion-icon>
                  Search
                </button>
                <button
                  class="back-btn"
                  onclick="goBack()"
                  id="backBtn"
                  style="display: none"
                >
                  <ion-icon name="arrow-back-outline"></ion-icon>
                  Back
                </button>
              </div>
            </div>

            <!-- Drag and Drop Area -->
            <div
              class="drag-drop-area"
              onclick="triggerFileUpload()"
              id="dragDropArea"
            >
              <input
                type="file"
                id="excelUpload"
                accept=".xlsx,.xls"
                style="display: none"
              />
              <div class="icon">
                <ion-icon name="cloud-upload-outline"></ion-icon>
              </div>
              <div class="text">Drag and drop your Excel file here</div>
              <div class="subtext">
                or click to browse for files (.xlsx, .xls)
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Upload Status -->
            <div id="uploadStatus" class="upload-status"></div>

            <!-- Manual Upload Form -->
            <div id="uploadForm" class="upload-form" style="display: none">
              <h3>
                <ion-icon name="add-circle-outline"></ion-icon>
                Add New Delivery Note
              </h3>
              <form id="deliveryNoteForm" onsubmit="submitDeliveryNote(event)">
                <input type="text" id="dnNo" placeholder="DN Number" required />
                <input type="text" id="mrNo" placeholder="MR Number" />
                <input
                  type="text"
                  id="customer"
                  placeholder="Customer"
                  required
                />
                <input
                  type="text"
                  id="projectName"
                  placeholder="Project Name"
                  required
                />
                <input
                  type="text"
                  id="siteAddress"
                  placeholder="Site Address"
                  required
                />
                <input
                  type="text"
                  id="contractInfo"
                  placeholder="Contract Info"
                />
                <input
                  type="text"
                  id="fromWarehouse"
                  placeholder="From Warehouse"
                />
                <input
                  type="text"
                  id="receiverName"
                  placeholder="Receiver Name"
                />
                <input type="tel" id="customerTel" placeholder="Customer Tel" />
                <textarea
                  id="purposeDelivery"
                  placeholder="Purpose of Delivery"
                  rows="3"
                ></textarea>
                <button type="submit">
                  <ion-icon name="save-outline"></ion-icon>
                  Save to Database
                </button>
                <button type="button" onclick="toggleUploadForm()">
                  <ion-icon name="close-outline"></ion-icon>
                  Cancel
                </button>
              </form>
            </div>

            <!-- Processed Excel Data Display -->
            <div id="excelData" class="excel-data" style="display: none">
              <h3>
                <ion-icon name="document-text-outline"></ion-icon>
                Processed Delivery Note Data
              </h3>
              <div id="excelDataContent"></div>
              <div style="text-align: center; margin-top: 20px">
                <button
                  class="upload-btn"
                  onclick="uploadProcessedData()"
                  id="uploadProcessedBtn"
                >
                  <ion-icon name="cloud-upload-outline"></ion-icon>
                  Upload to Database
                </button>
                <button
                  class="upload-btn secondary"
                  onclick="downloadJSON()"
                  id="downloadJsonBtn"
                >
                  <ion-icon name="download-outline"></ion-icon>
                  Download JSON
                </button>
              </div>
            </div>
          </div>

          <!-- Delivery Notes Table -->
          <div class="table-container" id="deliveryNotesTable">
            <div class="table-header">
              <ion-icon name="list-outline"></ion-icon>
              Delivery Notes Database
            </div>
            <div style="overflow-x: auto">
              <table class="delivery-notes-table">
                <thead>
                  <tr>
                    <th>DN No</th>
                    <th>Customer</th>
                    <th>Project</th>
                    <th>Site Address</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="deliveryNotesTableBody">
                  <!-- Dynamic content will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      // Global variables
      let processedDeliveryNote = null;
      let allDeliveryNotes = [];
      let currentView = "all";

      // DOM elements
      const fileInput = document.getElementById("excelUpload");
      const dragDropArea = document.getElementById("dragDropArea");
      const uploadStatus = document.getElementById("uploadStatus");
      const excelData = document.getElementById("excelData");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const searchInput = document.getElementById("searchInput");
      const backBtn = document.getElementById("backBtn");
      const clearBtn = document.getElementById("clearBtn");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        initializeEventListeners();
        loadDeliveryNotes();
      });

      function initializeEventListeners() {
        // File input handling
        fileInput.addEventListener("change", handleFileSelect);

        // Drag and drop
        dragDropArea.addEventListener("dragover", handleDragOver);
        dragDropArea.addEventListener("dragleave", handleDragLeave);
        dragDropArea.addEventListener("drop", handleFileDrop);

        // Prevent default drag behaviors on document
        document.addEventListener("dragover", (e) => e.preventDefault());
        document.addEventListener("drop", (e) => e.preventDefault());
      }

      // File handling functions
      function triggerFileUpload() {
        fileInput.click();
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          processExcelFile(file);
        }
      }

      function handleDragOver(event) {
        event.preventDefault();
        dragDropArea.classList.add("dragover");
      }

      function handleDragLeave(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");
      }

      function handleFileDrop(event) {
        event.preventDefault();
        dragDropArea.classList.remove("dragover");

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          processExcelFile(files[0]);
        }
      }

      // Excel processing functions
      function processExcelFile(file) {
        if (!validateFile(file)) return;

        showStatus("📊 Processing Excel file...", "processing", true);
        updateProgress(10);

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            updateProgress(30);
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {
              type: "array",
              cellStyles: true,
              cellFormulas: true,
              cellDates: true,
            });

            updateProgress(50);

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            updateProgress(70);

            const extractedData = extractDeliveryNoteData(worksheet);

            updateProgress(90);

            processedDeliveryNote = extractedData;
            displayExcelData(extractedData);

            updateProgress(100);
            showStatus(
              "✅ Excel file processed successfully! Review data and upload to database.",
              "success"
            );
          } catch (error) {
            console.error("Error processing file:", error);
            showStatus(
              "❌ Error processing Excel file: " + error.message,
              "error"
            );
            updateProgress(0);
          }
        };

        reader.onerror = function () {
          showStatus("❌ Error reading file. Please try again.", "error");
          updateProgress(0);
        };

        reader.readAsArrayBuffer(file);
      }

      function validateFile(file) {
        if (!file.name.match(/\.(xlsx|xls)$/i)) {
          showStatus(
            "❌ Please select a valid Excel file (.xlsx or .xls)",
            "error"
          );
          return false;
        }

        if (file.size > 10 * 1024 * 1024) {
          showStatus(
            "❌ File size too large. Please select a file smaller than 10MB",
            "error"
          );
          return false;
        }

        return true;
      }

      function extractDeliveryNoteData(worksheet) {
        const getCellValue = (cellRefs) => {
          const refs = Array.isArray(cellRefs) ? cellRefs : [cellRefs];

          for (const cellRef of refs) {
            const cell = worksheet[cellRef];
            if (cell && cell.v !== undefined && cell.v !== "") {
              return String(cell.v).trim();
            }
          }
          return "";
        };

        return {
          print_date: formatDateTime(getCellValue(["B2", "A2"])) || getCurrentDateTime(),
          purpose_of_delivery: getCellValue(["C3", "D3", "E3"]),
          delivery_address: getCellValue(["C4", "D4", "E4"]),
          site_Code: getCellValue(["C5", "D5", "E5"]),
          contract_info: getCellValue(["C6", "D6", "E6"]),
          Customer: getCellValue(["G8", "H8", "I8"]),
          Customer_PO: getCellValue(["N8", "O8"]),
          Customer_Tel: getCellValue(["M4", "L4"]),
          Project_Name: getCellValue(["C7", "D7", "E7"]),
          Project_Code: getCellValue(["N7", "O7"]),
          Product_Category: getCellValue(["C8", "D8", "E8"]),
          Product_Manager: getCellValue(["G9", "H9"]),
          Special_Unloading_Req: getCellValue(["C9", "D9", "E9"]),
          Installation_Environment: getCellValue(["C10", "D10", "E10"]),
          Description_MR: getCellValue(["C11", "D11", "E11"]),
          From_Warehouse: getCellValue(["C12", "D12", "E12"]),
          Warehouse_Keeper: getCellValue(["G12", "H12"]),
          Warehouse_Keeper_tel: getCellValue(["N12", "O12"]),
          Description_DN: getCellValue(["C13", "D13", "E13"]),
          Including_dangerous_goods: getCellValue(["C14", "D14", "E14"]) || "No",
          pickup_address: getCellValue(["G3", "H3", "I3", "J3"]),
          Site_Address: getCellValue(["G4", "H4", "I4", "J4"]),
          dn_no: getCellValue(["O1", "N1", "P1"]) || generateDNNumber(),
          mr_no: getCellValue(["O2", "N2", "P2"]),
          receiver_name: getCellValue(["M3", "L3"]),
          receiver_tel: getCellValue(["M4", "L4"]),
          Receiver_Company_Name: getCellValue(["M10", "N10", "O10"]),
          request_arrived_date: formatDateTime(getCellValue(["G5", "H5"])),
          request_shipment_date: formatDateTime(getCellValue(["N5", "O5"])),
          logistics_specialist: getCellValue(["G6", "H6"]),
          logistics_specialist_Tel: getCellValue(["H6", "I6"]),
          received_location: getCellValue(["G13", "H13"]),
          received_Auto_location: getCellValue(["G14", "H14"]),
          Collected_location: getCellValue(["G15", "H15"]),
          Collected_Auto_location: getCellValue(["G16", "H16"]),
          Company_code: getCellValue(["A1", "B1"])
        };
      }

      // Utility functions
      function formatDateTime(dateValue) {
        if (!dateValue) return null;

        if (typeof dateValue === "string") {
          if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) return dateValue;

          const parsedDate = new Date(dateValue);
          if (!isNaN(parsedDate.getTime())) {
            return parsedDate.toISOString().slice(0, 19).replace("T", " ");
          }
        }

        if (typeof dateValue === "number") {
          try {
            const excelDate = XLSX.SSF.parse_date_code(dateValue);
            if (excelDate) {
              return `${excelDate.y}-${String(excelDate.m).padStart(
                2,
                "0"
              )}-${String(excelDate.d).padStart(2, "0")} 00:00:00`;
            }
          } catch (e) {
            console.warn("Date parsing error:", e);
          }
        }

        return null;
      }

      function getCurrentDateTime() {
        return new Date().toISOString().slice(0, 19).replace("T", " ");
      }

      function generateDNNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const random = Math.floor(Math.random() * 10000)
          .toString()
          .padStart(4, "0");
        return `KSD${year}${month}${day}${random}`;
      }

      // Display functions
      function showStatus(message, type = "success", showSpinner = false) {
        const spinner = showSpinner
          ? '<div class="loading-spinner"></div>'
          : "";
        uploadStatus.innerHTML = `${spinner}${message}`;
        uploadStatus.className = `upload-status ${type}`;
        uploadStatus.style.display = "block";

        if (!showSpinner && type === "success") {
          setTimeout(() => {
            uploadStatus.style.display = "none";
          }, 5000);
        }
      }

      function updateProgress(percentage) {
        progressBar.style.display = "block";
        progressFill.style.width = percentage + "%";

        if (percentage >= 100) {
          setTimeout(() => {
            progressBar.style.display = "none";
          }, 1000);
        }
      }

      function displayExcelData(data) {
        const fieldLabels = {
          print_date: "Print Date",
          dn_no: "DN Number",
          mr_no: "MR Number",
          purpose_of_delivery: "Purpose of Delivery",
          delivery_address: "Delivery Address",
          site_code: "Site Code",
          contract_info: "Contract Info",
          project_name: "Project Name",
          customer: "Customer",
          receiver_name: "Receiver Name",
          customer_tel: "Customer Tel",
          from_warehouse: "From Warehouse",
          pickup_address: "Pickup Address",
          site_address: "Site Address",
        };

        let html = '<div class="data-grid">';

        for (const [key, value] of Object.entries(data)) {
          if (value && value.toString().trim() !== "") {
            const label =
              fieldLabels[key] ||
              key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
            html += `
              <div class="data-item">
                <strong>${label}</strong>
                <span>${value}</span>
              </div>
            `;
          }
        }

        html += "</div>";
        document.getElementById("excelDataContent").innerHTML = html;
        excelData.style.display = "block";
        clearBtn.style.display = "inline-flex";
      }

      // Form handling
      function toggleUploadForm() {
        const form = document.getElementById("uploadForm");
        form.style.display = form.style.display === "none" ? "block" : "none";

        if (form.style.display === "block") {
          document.getElementById("dnNo").focus();
        }
      }

      function submitDeliveryNote(event) {
        event.preventDefault();

        const formData = {
          dn_no: document.getElementById("dnNo").value,
          Customer: document.getElementById("customer").value,
          Project_Name: document.getElementById("projectName").value,
          Site_Address: document.getElementById("siteAddress").value,
          site_Code: document.getElementById("siteCode").value || '',
          Customer_PO: document.getElementById("customerPO").value || '',
          Customer_Tel: document.getElementById("customerTel").value || '',
          Project_Code: document.getElementById("projectCode").value || '',
          Product_Category: document.getElementById("productCategory").value || '',
          Product_Manager: document.getElementById("productManager").value || '',
          receiver_name: document.getElementById("receiverName").value || '',
          receiver_tel: document.getElementById("receiverTel").value || '',
          Receiver_Company_Name: document.getElementById("receiverCompany").value || ''
        };

        uploadToDatabase(formData);
      }

      // Database operations
      async function uploadProcessedData() {
        if (!processedDeliveryNote) {
          showStatus("❌ No data to upload", "error");
          return;
        }

        await uploadToDatabase(processedDeliveryNote);
      }

      async function uploadToDatabase(data) {
        try {
          showStatus("🚀 Uploading to database...", "processing", true);
          updateProgress(20);

          const response = await fetch("api/upload-delivery-note.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(data),
          });

          updateProgress(60);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          updateProgress(90);

          if (result.success) {
            updateProgress(100);
            showStatus(
              `✅ Successfully uploaded! DN: ${result.dn_no || data.dn_no}`,
              "success"
            );

            // Add to local storage for immediate display
            const newNote = {
              id: result.delivery_note_id || Date.now(),
              ...data,
              DN_Status: "Created",
              created_at: getCurrentDateTime(),
            };
            allDeliveryNotes.unshift(newNote);
            updateDeliveryNotesTable();

            // Reset forms
            clearExcelData();
            toggleUploadForm();
            document.getElementById("deliveryNoteForm").reset();
          } else {
            throw new Error(result.error || "Upload failed");
          }
        } catch (error) {
          console.error("Upload error:", error);
          updateProgress(0);

          let errorMessage = "❌ Upload failed: ";
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            errorMessage +=
              "Cannot connect to server. Please check if api/api/upload-delivery-note.php exists.";
          } else {
            errorMessage += error.message;
          }

          showStatus(errorMessage, "error");
        }
      }

      async function loadDeliveryNotes() {
        try {
          // Try to load from server
          const response = await fetch("api/upload-delivery-note.php", {
            method: "GET",
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              allDeliveryNotes = result.data;
              updateDeliveryNotesTable();
              return;
            }
          }
        } catch (error) {
          console.log("Could not load from server, using demo data");
        }

        // Fallback to demo data
        // allDeliveryNotes = [
        //   {
        //     id: 1,
        //     dn_no: "KSD202409190001",
        //     customer: "Demo Customer 1",
        //     project_name: "Sample Project Alpha",
        //     site_address: "Demo Location 1",
        //     DN_Status: "Created",
        //     created_at: "2024-09-19 10:00:00",
        //   },
        //   {
        //     id: 2,
        //     dn_no: "KSD202409190002",
        //     customer: "Demo Customer 2",
        //     project_name: "Sample Project Beta",
        //     site_address: "Demo Location 2",
        //     DN_Status: "Delivered",
        //     created_at: "2024-09-19 09:30:00",
        //   },
        // ];
        updateDeliveryNotesTable();
      }

      function updateDeliveryNotesTable(notesToShow = null) {
        const tbody = document.getElementById("deliveryNotesTableBody");
        const notes = notesToShow || allDeliveryNotes;

        if (notes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                <ion-icon name="document-outline" style="font-size: 2em; margin-bottom: 10px;"></ion-icon>
                <br>No delivery notes found
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = notes
          .map(
            (note) => `
          <tr>
            <td><strong>${note.dn_no || "N/A"}</strong></td>
            <td>${note.customer || "N/A"}</td>
            <td>${note.project_name || "N/A"}</td>
            <td title="${note.site_address || "N/A"}">${truncateText(
              note.site_address || "N/A",
              30
            )}</td>
            <td><span class="status-badge status-${(
              note.DN_Status || "created"
            ).toLowerCase()}">${note.DN_Status || "Created"}</span></td>
            <td>${formatDisplayDate(note.created_at)}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn view" onclick="viewDeliveryNote(${
                  note.id
                })" title="View Details">
                  <ion-icon name="eye-outline"></ion-icon>
                </button>
                <button class="action-btn edit" onclick="editDeliveryNote(${
                  note.id
                })" title="Edit">
                  <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="action-btn delete" onclick="deleteDeliveryNote(${
                  note.id
                })" title="Delete">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Utility functions for table
      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }

      function formatDisplayDate(dateString) {
        if (!dateString) return "N/A";
        try {
          const date = new Date(dateString);
          return (
            date.toLocaleDateString() +
            " " +
            date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
          );
        } catch {
          return dateString;
        }
      }

      // Search and filter functions
      function handleSearchKeyPress(event) {
        if (event.key === "Enter") {
          performSearch();
        }
      }

      function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          showStatus("Please enter a search term", "error");
          return;
        }

        const filteredNotes = allDeliveryNotes.filter(
          (note) =>
            (note.dn_no && note.dn_no.toLowerCase().includes(searchTerm)) ||
            (note.customer &&
              note.customer.toLowerCase().includes(searchTerm)) ||
            (note.project_name &&
              note.project_name.toLowerCase().includes(searchTerm)) ||
            (note.site_address &&
              note.site_address.toLowerCase().includes(searchTerm)) ||
            (note.mr_no && note.mr_no.toLowerCase().includes(searchTerm))
        );

        updateDeliveryNotesTable(filteredNotes);
        backBtn.style.display = "inline-flex";
        currentView = "search";

        showStatus(
          `Found ${filteredNotes.length} delivery note(s) matching "${searchTerm}"`,
          "success"
        );
      }

      function goBack() {
        searchInput.value = "";
        backBtn.style.display = "none";
        currentView = "all";
        updateDeliveryNotesTable();
        showStatus("Showing all delivery notes", "success");
      }

      // Additional functions
      function showSavedExcelSheets() {
        currentView = "all";
        updateDeliveryNotesTable();
        showStatus(
          `Showing ${allDeliveryNotes.length} delivery notes from database`,
          "success"
        );
      }

      function clearExcelData() {
        processedDeliveryNote = null;
        excelData.style.display = "none";
        clearBtn.style.display = "none";
        fileInput.value = "";
        showStatus("Excel data cleared", "success");
      }

      function clearAllData() {
        if (
          confirm(
            "Are you sure you want to clear all processed data? This will not affect the database."
          )
        ) {
          clearExcelData();
          document.getElementById("deliveryNoteForm").reset();
          toggleUploadForm();
        }
      }

      function downloadJSON() {
        if (!processedDeliveryNote) {
          showStatus("No data to download", "error");
          return;
        }

        const dataStr = JSON.stringify(processedDeliveryNote, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement("a");
        link.href = url;
        link.download = `delivery_note_${
          processedDeliveryNote.dn_no || "data"
        }.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showStatus("JSON file downloaded successfully", "success");
      }

      // Action functions for table rows
      function viewDeliveryNote(id) {
        const note = allDeliveryNotes.find((n) => n.id === id);
        if (note) {
          // Create and show a modal or detailed view
          alert(
            `Delivery Note Details:\n\nDN: ${note.dn_no}\nCustomer: ${note.customer}\nProject: ${note.project_name}\nStatus: ${note.DN_Status}\nCreated: ${note.created_at}`
          );
        }
      }

      function editDeliveryNote(id) {
        const note = allDeliveryNotes.find((n) => n.id === id);
        if (note) {
          // Populate the form with existing data
          document.getElementById("dnNo").value = note.dn_no || "";
          document.getElementById("mrNo").value = note.mr_no || "";
          document.getElementById("customer").value = note.customer || "";
          document.getElementById("projectName").value =
            note.project_name || "";
          document.getElementById("siteAddress").value =
            note.site_address || "";
          document.getElementById("contractInfo").value =
            note.contract_info || "";
          document.getElementById("fromWarehouse").value =
            note.from_warehouse || "";
          document.getElementById("receiverName").value =
            note.receiver_name || "";
          document.getElementById("customerTel").value =
            note.customer_tel || "";
          document.getElementById("purposeDelivery").value =
            note.purpose_of_delivery || "";

          toggleUploadForm();
          showStatus(
            "Editing delivery note. Modify fields and save.",
            "success"
          );
        }
      }

      function deleteDeliveryNote(id) {
        if (confirm("Are you sure you want to delete this delivery note?")) {
          allDeliveryNotes = allDeliveryNotes.filter((n) => n.id !== id);
          updateDeliveryNotesTable();
          showStatus("Delivery note deleted successfully", "success");
        }
      }
    </script>

    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
